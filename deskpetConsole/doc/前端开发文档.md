# 前端开发文档

## 项目概述

DeskPet 控制台前端包含两个独立项目：

| 项目 | 目录 | 端口 | 说明 |
|------|------|------|------|
| **管理后台** | `deskpetConsole/manager/` | 5173 | 面向管理员，设备管理、授权码管理、产品物模型、日志等 |
| **用户端** | `deskpetConsole/user-frontend/` | 5174 | 面向终端用户，登录注册、授权码激活、设备查看与控制 |

两个项目共享同一后端服务（`pet-core`，端口 8080），通过 Vite 开发代理 `/api` 转发请求。

## 技术选型

### 共用技术栈
- 框架：Vue 3 + Vite + TypeScript
- 状态管理：Pinia
- 路由：Vue Router（含路由守卫）
- HTTP 客户端：Axios（Bearer Token 认证）
- 图表：ECharts
- 认证：Sa-Token（后端）+ localStorage Token（前端）

### 管理后台
- UI 组件库：Element Plus
- 布局：固定侧边栏 + 主内容区

### 用户端
- UI 组件库：Element Plus（PC 端 ≥768px）+ Vant 4（移动端 <768px）
- 布局：PC 端侧边栏 / 移动端底部 TabBar
- 响应式切换：`useResponsive()` composable

## 开发环境

- Node.js：LTS 版本（建议 20.x 或 22.x）
- 包管理器：npm
- IDE：IntelliJ IDEA / VS Code

## 启动与构建

```bash
# 管理后台
cd deskpetConsole/manager
npm install
npm run dev      # 启动开发服务器（端口 5173）
npm run build    # 生产构建

# 用户端
cd deskpetConsole/user-frontend
npm install
npm run dev      # 启动开发服务器（端口 5174）
npm run build    # 生产构建
```

## 环境配置

两个项目均使用 `.env.development`：

```env
VITE_API_URL=/api
```

Vite 开发代理将 `/api` 转发到 `http://localhost:8080`，并去除 `/api` 前缀。

## 目录结构

两个项目采用相同的目录结构规范：

```
src/
  api/               # 接口封装（函数式导出）
  composables/       # 组合式函数（usePolling, useResponsive 等）
  layouts/           # 布局组件（用户端特有）
  pages/             # 页面组件
  router/            # 路由配置与守卫
  stores/            # Pinia 状态管理
  styles/            # 全局样式与 CSS 变量
  types/             # TypeScript 类型定义（与后端 DTO 对应）
  utils/             # 工具方法（request.ts, format.ts）
```

## 认证与权限

### 认证流程
1. 用户访问受保护页面 → 路由守卫检查 `localStorage.token`
2. 无 token → 跳转登录页（携带 `redirect` 参数）
3. 登录成功 → 后端返回 Sa-Token UUID → 前端存入 localStorage
4. 后续请求 → Axios 拦截器自动添加 `Authorization: Bearer {token}`
5. 401 响应 → 清除本地认证信息 → 跳转登录页

### 路由守卫
- `requiresAuth`：需要登录才能访问（默认）
- `guest`：仅未登录可访问（登录页、注册页）

## 管理后台页面

| 路由 | 页面 | 功能 |
|------|------|------|
| `/login` | Login | 管理员登录 |
| `/` | Dashboard | 总览仪表盘 |
| `/licenses` | Licenses | 授权码管理（生成、查询、撤销、导出） |
| `/products` | Products | 产品管理 |
| `/products/:productKey` | ThingModel | 产品物模型编辑（属性/服务/事件） |
| `/devices` | Devices | 设备列表与管理 |
| `/devices/:id` | DeviceDetail | 设备详情（遥测、指令） |
| `/commands` | Commands | 指令管理 |
| `/telemetry` | Telemetry | 遥测数据面板 |
| `/logs` | Logs | 操作日志 |
| `/settings` | Settings | 系统设置 |

## 用户端页面

| 路由 | 页面 | 功能 |
|------|------|------|
| `/auth/login` | Login | 用户登录（双 UI 适配） |
| `/auth/register` | Register | 用户注册（双 UI 适配） |
| `/home` | Home | 首页（设备概览、快捷入口） |
| `/devices` | MyDevices | 我的设备列表 |
| `/devices/:deviceId` | DeviceControl | 设备控制（指令/遥测/事件三 Tab） |
| `/activate` | ActivateLicense | 激活授权码 |
| `/profile` | Profile | 个人中心（信息编辑、授权码列表、退出） |

## 接口约定

- 基础路径：`/api`（开发代理去除前缀后转发到后端）
- 认证头：`Authorization: Bearer {sa-token}`
- 错误格式：`{ code: string, message: string, details?: object }`
- 管理端 API 前缀：`/api/admin/...`
- 用户端 API 前缀：`/api/user/...`、`/api/auth/...`

## 状态与缓存策略

- 设备列表：Pinia 缓存 + `usePolling` 定时刷新（10 秒）
- 遥测数据：接口获取 + ECharts 渲染
- 用户信息：Pinia 缓存 + localStorage 持久化 token
