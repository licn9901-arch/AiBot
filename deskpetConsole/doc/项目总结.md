# DeskPet 项目总结与 V0.2 迭代计划

## 1. 项目概览

**DeskPet** 是一个桌面轮式机器人及其配套的软硬件生态系统。本项目（`deskpetConsole`）为其核心控制台与后端服务。
V0.1 版本已达成 MVP（最小可行性产品）目标，实现了**联网闭环**，打通了从前端控制台到后端服务，再到 MQTT 网关及模拟设备的完整链路。

## 2. V0.1 交付现状

### 2.1 前端 (Frontend)
- **技术栈**：Vue 3, TypeScript, Vite, Element Plus, Pinia, Axios.
- **核心功能**：
  - **设备管理**：设备列表查询、详情展示、在线状态监控（实时轮询）。
  - **指令控制**：发送移动 (Move)、表情 (SetEmotion) 等指令，并查看执行回执 (Ack)。
  - **可观测性**：集成了日志 (Logs) 与遥测 (Telemetry) 面板。
- **质量保障**：
  - **E2E 测试**：Playwright 覆盖关键流程（Dashboard -> Device -> Detail）。
  - **单元测试**：Vitest 覆盖核心工具类（拦截器、状态处理）。
  - **健壮性**：全局 404 页面，统一的 API 错误处理与 Token 失效跳转。

### 2.2 后端 (Backend)
- **核心服务 (`pet-core`)**：
  - 基于 Spring Boot。
  - 提供了标准的 REST API (`DeviceController`, `CommandController`)。
  - 实现了指令状态机 (`SENT` -> `ACKED`/`TIMEOUT`)。
- **网关服务 (`mqtt-gateway`)**：
  - 基于 Vert.x MQTT。
  - 处理设备连接、鉴权、心跳及 MQTT 消息转发。

### 2.3 部署与运维
- **构建**：前端生产环境构建脚本，支持代码分割与 gzip 预压缩。
- **配置**：多环境配置 (`.env.dev`, `.env.prod`)。
- **文档**：提供了详细的 Nginx 部署指南。

---

## 3. V0.2 迭代计划：行为与自动化

V0.2 的核心目标是**让桌宠“活”起来**。从单纯的“遥控模式”进化为具备一定自主行为与定时任务的自动模式。

### 3.1 核心需求 (Backend)

| 模块 | 功能点 | 说明 |
| :--- | :--- | :--- |
| **行为引擎** | **状态机 (FSM)** | 在后端实现设备状态（Idle/Walking/Sleeping）管理。 |
|  | **行为树/脚本** | 允许定义简单的行为序列（如：检测到低电量 -> 停止运动 -> 显示难过表情）。 |
| **任务调度** | **定时任务** | 支持 Crontab 风格的定时指令（如：整点报时、早上 8 点叫醒）。 |
| **遥测增强** | **历史数据分析** | 接入时序存储（或优化 SQL），支持查询更长时间跨度的电量/信号曲线。 |

### 3.2 前端演进 (Frontend)

1.  **行为可视化**
    -   新增“状态监控”面板，实时显示设备当前的 FSM 状态。
    -   (可选) 简单的行为编排 UI。

2.  **定时任务管理**
    -   新增“计划任务”页面，用于增删改查定时指令。
    -   支持复杂的重复规则（如“工作日每天 10:00”）。

3.  **交互体验升级**
    -   **虚拟桌宠**：在详情页增加一个基于 CSS/Canvas 的虚拟形象，实时同步物理设备的表情和动作，用于远程预览。
    -   **快捷指令板**：允许用户自定义常用指令组合（宏）。

4.  **架构与质量**
    -   引入 WebSocket (或 SSE) 替换轮询，提升状态同步的实时性与性能。
    -   扩大 E2E 测试覆盖率，覆盖编辑与创建流程。

## 4. 建议的下一步

1.  **后端先行**：优先设计并实现 `BehaviorService` 和 `SchedulerService`。
2.  **协议扩充**：更新 MQTT 物模型，增加 `event` 上报（如触摸、跌倒），不仅仅是 telemetry。
3.  **前端跟进**：待后端 API 就绪后，启动 V0.2 前端开发。
