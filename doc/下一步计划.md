# DeskPet 项目分析与下一步计划

## 一、项目现状总结

### 1. 整体架构

```
┌─────────────────┐     HTTP API      ┌─────────────────┐
│  deskpetConsole │ ◄───────────────► │    pet-core     │
│   (Vue 3 前端)   │                   │  (Spring Boot)  │
└─────────────────┘                   └────────┬────────┘
                                               │ Internal HTTP
┌─────────────────┐     HTTP API      ┌────────▼────────┐
│     pet-ai      │ ◄───────────────► │  mqtt-gateway   │
│  (Spring AI)    │                   │    (Vert.x)     │
└─────────────────┘                   └────────┬────────┘
                                               │ MQTT
                                      ┌────────▼────────┐
                                      │   硬件设备       │
                                      │  (ESP32 等)     │
                                      └─────────────────┘
```

### 2. 各模块现状

| 模块 | 技术栈 | 功能 | 完成度 |
|------|--------|------|--------|
| **pet-core** | Spring Boot 3.3 + PostgreSQL | 设备注册/查询、指令下发、遥测存储、内部API | ✅ 基本完成 |
| **mqtt-gateway** | Vert.x 4.5 | MQTT接入、设备认证、消息转发、Prometheus指标 | ✅ 基本完成 |
| **pet-ai** | Spring AI + OpenAI兼容API | AI对话、Tool Calling控制设备 | ✅ 基本完成 |
| **deskpetConsole** | Vue 3 + TypeScript | 管理控制台（设备/指令/遥测/日志/授权码/产品/物模型） | ✅ V0.4 管理后台完成 |

### 3. 物模型概念说明

物模型（Thing Model）是对设备能力的抽象描述，包含三大要素：

| 要素 | 方向 | 说明 | 示例 |
|------|------|------|------|
| **属性（Property）** | 双向 | 设备状态，可读可写 | 电量、亮度、开关状态 |
| **服务/指令（Service）** | 下行 | 云端调用设备执行 | 移动、设置表情、播放音频 |
| **事件（Event）** | 上行 | 设备主动上报 | 碰撞、触摸、低电量告警 |

```
        ┌─────────────────────────────────────┐
        │              物模型                  │
        ├───────────┬───────────┬─────────────┤
        │   属性     │   服务    │    事件      │
        │ Property  │  Service  │   Event     │
        ├───────────┼───────────┼─────────────┤
        │ • battery │ • move    │ • collision │
        │ • rssi    │ • stop    │ • touch     │
        │ • online  │ • emotion │ • lowBattery│
        │ • version │ • speak   │ • fall      │
        └───────────┴───────────┴─────────────┘
```

### 4. 数据模型现状

**现有表结构（PostgreSQL）：**

```sql
-- 设备表
device (device_id, secret_hash, secret_salt, model, remark, created_at)

-- 设备会话表（在线状态）
device_session (device_id, gateway_id, client_ip, connected_at)

-- 指令表
command (req_id, device_id, action, payload, status, ack_code, ack_message, created_at, acked_at)

-- 遥测最新值
telemetry_latest (device_id, data, updated_at)

-- 遥测历史
telemetry_history (id, device_id, data, created_at)
```

### 5. 当前缺失的关键功能

| 功能 | 现状 | 影响 |
|------|------|------|
| **用户系统** | ✅ 已完成 | V0.2 实现 RBAC + Sa-Token |
| **授权码/设备绑定** | ✅ 已完成 | V0.2 实现授权码生成/激活/撤销 |
| **物模型管理** | ✅ 已完成 | V0.3 实现属性/服务/事件动态配置 |
| **事件上报** | ✅ 已完成 | V0.3 实现 MQTT 事件转发 |
| **操作日志** | ✅ 已完成 | V0.2 实现异步操作日志 |
| **管理后台增强** | ✅ 已完成 | V0.4 新增授权码/产品/物模型管理页面 |
| **时序数据库** | ❌ 无 | 遥测/事件历史查询效率低 |
| **用户端前端** | ❌ 无 | 只有管理控制台，无普通用户界面 |

---

## 二、下一步计划

### 方案概览

| 版本 | 主题 | 核心功能 |
|------|------|----------|
| V0.2 | 用户系统 + 授权码 | 用户注册/登录、JWT鉴权、授权码购买/激活、设备绑定 |
| V0.3 | 物模型管理 | 属性/服务/事件定义、事件上报、动态物模型 |
| V0.4 | 前端分离 | 管理后台增强（✅ 已完成） + 用户端App（进行中） |
| V0.5 | 可观测性增强 | 操作日志、时序数据库、告警 |
| V0.6 | 行为与交互 | 行为状态机、定时卖萌、事件触发 |

---

## 三、V0.2 用户系统 + 授权码（推荐优先）

### 3.1 授权码商业模式

```
┌─────────────────────────────────────────────────────────────────┐
│                        授权码流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 管理员生成授权码批次                                          │
│     ┌──────────┐                                                │
│     │  Admin   │ ──► 生成 100 个授权码 ──► 存入数据库             │
│     └──────────┘                                                │
│                                                                 │
│  2. 用户购买授权码（线下/电商平台）                                │
│     ┌──────────┐      ┌──────────┐                              │
│     │   用户   │ ──► │  商家    │ ──► 获得授权码卡片              │
│     └──────────┘      └──────────┘                              │
│                                                                 │
│  3. 用户激活授权码绑定设备                                        │
│     ┌──────────┐                     ┌──────────┐               │
│     │   用户   │ ──► 输入授权码 ──► │ pet-core │               │
│     │   App    │ ◄── 绑定成功 ◄──── │          │               │
│     └──────────┘                     └──────────┘               │
│                                                                 │
│  约束：一个授权码只能绑定一个设备，一个设备只能被一个授权码绑定      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 RBAC 权限模型

```
┌─────────────────────────────────────────────────────────────────┐
│                      RBAC 权限模型                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   用户(User) ──── 多对多 ──── 角色(Role) ──── 多对多 ──── 权限(Permission)
│                                                                 │
│   示例：                                                         │
│   ┌────────┐      ┌────────┐      ┌─────────────────────┐      │
│   │ 张三   │ ───► │ USER   │ ───► │ device:bindLicense  │      │
│   └────────┘      │        │      │ device:view         │      │
│                   │        │      │ device:control      │      │
│   ┌────────┐      └────────┘      └─────────────────────┘      │
│   │ 管理员 │ ───► ┌────────┐      ┌─────────────────────┐      │
│   └────────┘      │ ADMIN  │ ───► │ user:*              │      │
│                   │        │      │ license:*           │      │
│                   │        │      │ product:*           │      │
│                   │        │      │ device:*            │      │
│                   └────────┘      └─────────────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 新增数据表

```sql
-- ==================== 用户与权限 ====================

-- 用户表
CREATE TABLE sys_user (
    id              BIGSERIAL PRIMARY KEY,
    username        VARCHAR(50) NOT NULL UNIQUE,
    password_hash   VARCHAR(255) NOT NULL,
    email           VARCHAR(100),
    phone           VARCHAR(20),
    avatar          VARCHAR(255),
    status          VARCHAR(20) NOT NULL DEFAULT 'ACTIVE', -- ACTIVE / DISABLED
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP
);

-- 角色表
CREATE TABLE sys_role (
    id              BIGSERIAL PRIMARY KEY,
    code            VARCHAR(50) NOT NULL UNIQUE,   -- 角色编码：ADMIN / USER / OPERATOR
    name            VARCHAR(100) NOT NULL,          -- 角色名称
    description     VARCHAR(255),
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 权限表
CREATE TABLE sys_permission (
    id              BIGSERIAL PRIMARY KEY,
    code            VARCHAR(100) NOT NULL UNIQUE,  -- 权限编码：user:create, device:control
    name            VARCHAR(100) NOT NULL,          -- 权限名称
    description     VARCHAR(255),
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 用户-角色关联表
CREATE TABLE sys_user_role (
    id              BIGSERIAL PRIMARY KEY,
    user_id         BIGINT NOT NULL REFERENCES sys_user(id) ON DELETE CASCADE,
    role_id         BIGINT NOT NULL REFERENCES sys_role(id) ON DELETE CASCADE,
    UNIQUE(user_id, role_id)
);

-- 角色-权限关联表
CREATE TABLE sys_role_permission (
    id              BIGSERIAL PRIMARY KEY,
    role_id         BIGINT NOT NULL REFERENCES sys_role(id) ON DELETE CASCADE,
    permission_id   BIGINT NOT NULL REFERENCES sys_permission(id) ON DELETE CASCADE,
    UNIQUE(role_id, permission_id)
);

-- ==================== 授权码 ====================

-- 授权码表（核心）
CREATE TABLE license_code (
    id              BIGSERIAL PRIMARY KEY,
    code            VARCHAR(32) NOT NULL UNIQUE,          -- 授权码（如：DKPT-XXXX-XXXX-XXXX）
    batch_no        VARCHAR(50),                          -- 批次号（便于管理）
    status          VARCHAR(20) NOT NULL DEFAULT 'UNUSED', -- UNUSED / ACTIVATED / REVOKED
    device_id       VARCHAR(64) UNIQUE,                   -- 绑定的设备ID（一对一）
    user_id         BIGINT REFERENCES sys_user(id),       -- 激活的用户
    activated_at    TIMESTAMP,                            -- 激活时间
    expires_at      TIMESTAMP,                            -- 过期时间（可选，支持限时授权）
    remark          VARCHAR(255),                         -- 备注
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_license_code_status ON license_code(status);
CREATE INDEX idx_license_code_user ON license_code(user_id);
CREATE INDEX idx_license_code_device ON license_code(device_id);

-- 用户设备视图（通过授权码关联）
CREATE VIEW user_device_view AS
SELECT
    lc.user_id,
    lc.device_id,
    lc.code AS license_code,
    lc.activated_at AS bind_at,
    lc.expires_at,
    d.model,
    d.remark AS device_remark
FROM license_code lc
JOIN device d ON lc.device_id = d.device_id
WHERE lc.status = 'ACTIVATED';

-- ==================== 操作日志 ====================

CREATE TABLE operation_log (
    id              BIGSERIAL PRIMARY KEY,
    user_id         BIGINT REFERENCES sys_user(id),
    device_id       VARCHAR(64),
    action          VARCHAR(50) NOT NULL,  -- LOGIN / ACTIVATE_LICENSE / SEND_COMMAND / ...
    payload         JSONB,
    ip              VARCHAR(50),
    user_agent      VARCHAR(255),
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_operation_log_user ON operation_log(user_id, created_at DESC);
CREATE INDEX idx_operation_log_device ON operation_log(device_id, created_at DESC);

-- ==================== 初始化数据 ====================

-- 初始化角色
INSERT INTO sys_role (code, name, description) VALUES
('ADMIN', '系统管理员', '拥有所有权限'),
('USER', '普通用户', '可绑定设备、控制自己的设备'),
('OPERATOR', '运维人员', '可查看设备状态、日志，不可修改配置');

-- 初始化权限
INSERT INTO sys_permission (code, name) VALUES
-- 用户管理
('user:list', '用户列表'),
('user:create', '创建用户'),
('user:update', '更新用户'),
('user:delete', '删除用户'),
('user:disable', '禁用用户'),
-- 授权码管理
('license:list', '授权码列表'),
('license:generate', '生成授权码'),
('license:revoke', '撤销授权码'),
('license:export', '导出授权码'),
('license:activate', '激活授权码'),
-- 设备管理
('device:list', '设备列表'),
('device:view', '查看设备'),
('device:control', '控制设备'),
('device:register', '注册设备'),
('device:delete', '删除设备'),
-- 产品/物模型
('product:list', '产品列表'),
('product:create', '创建产品'),
('product:update', '更新产品'),
('product:delete', '删除产品'),
-- 日志
('log:list', '日志列表'),
('log:export', '导出日志');

-- ADMIN 角色拥有所有权限
INSERT INTO sys_role_permission (role_id, permission_id)
SELECT
    (SELECT id FROM sys_role WHERE code = 'ADMIN'),
    id
FROM sys_permission;

-- USER 角色权限
INSERT INTO sys_role_permission (role_id, permission_id)
SELECT
    (SELECT id FROM sys_role WHERE code = 'USER'),
    id
FROM sys_permission
WHERE code IN ('license:activate', 'device:view', 'device:control');

-- OPERATOR 角色权限
INSERT INTO sys_role_permission (role_id, permission_id)
SELECT
    (SELECT id FROM sys_role WHERE code = 'OPERATOR'),
    id
FROM sys_permission
WHERE code IN ('user:list', 'license:list', 'device:list', 'device:view', 'product:list', 'log:list');
```

### 3.3 授权码生成规则

```java
/**
 * 授权码格式：DKPT-XXXX-XXXX-XXXX（16位，含分隔符共19位）
 *
 * 组成：
 * - 前缀：DKPT（DeskPet缩写）
 * - 主体：12位大写字母+数字（排除易混淆字符 0/O/1/I/L）
 *
 * 示例：DKPT-A3B7-K9M2-X4N8
 */
public class LicenseCodeGenerator {
    private static final String CHARS = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
    private static final SecureRandom RANDOM = new SecureRandom();

    public static String generate() {
        StringBuilder sb = new StringBuilder("DKPT-");
        for (int i = 0; i < 12; i++) {
            if (i > 0 && i % 4 == 0) {
                sb.append('-');
            }
            sb.append(CHARS.charAt(RANDOM.nextInt(CHARS.length())));
        }
        return sb.toString();
    }

    // 批量生成
    public static List<String> generateBatch(int count) {
        Set<String> codes = new HashSet<>();
        while (codes.size() < count) {
            codes.add(generate());
        }
        return new ArrayList<>(codes);
    }
}
```

### 3.5 pet-core 改造

#### 新增类结构

```
com.deskpet.core
├── model/
│   ├── SysUser.java              # 用户实体
│   ├── SysRole.java              # 角色实体
│   ├── SysPermission.java        # 权限实体
│   ├── LicenseCode.java          # 授权码实体
│   └── OperationLog.java         # 操作日志实体
├── repository/
│   ├── SysUserRepository.java
│   ├── SysRoleRepository.java
│   ├── SysPermissionRepository.java
│   ├── LicenseCodeRepository.java
│   └── OperationLogRepository.java
├── dto/
│   ├── UserRegisterRequest.java
│   ├── UserLoginRequest.java
│   ├── UserLoginResponse.java       # 含 Token
│   ├── ActivateLicenseRequest.java  # 激活授权码请求
│   ├── LicenseCodeResponse.java
│   ├── GenerateLicenseRequest.java  # 批量生成授权码
│   └── UserResponse.java
├── service/
│   ├── UserService.java             # 用户注册/登录/查询
│   ├── LicenseCodeService.java      # 授权码生成/激活/查询
│   ├── PermissionService.java       # 权限查询（供 Sa-Token 使用）
│   └── OperationLogService.java
├── controller/
│   ├── AuthController.java          # POST /api/auth/register, /api/auth/login
│   ├── UserController.java          # GET /api/users/me, 我的设备等
│   ├── AdminUserController.java     # 管理员用户管理
│   └── AdminLicenseController.java  # 管理员授权码管理
├── config/
│   ├── SaTokenConfig.java           # Sa-Token 配置
│   └── StpInterfaceImpl.java        # Sa-Token 权限数据加载实现
└── util/
    └── LicenseCodeGenerator.java
```

#### Sa-Token 权限数据加载

```java
/**
 * Sa-Token 权限数据加载实现
 * 实现 StpInterface 接口，告诉 Sa-Token 如何获取用户的权限和角色
 */
@Component
public class StpInterfaceImpl implements StpInterface {

    @Autowired
    private PermissionService permissionService;

    /**
     * 返回用户拥有的权限码集合
     */
    @Override
    public List<String> getPermissionList(Object loginId, String loginType) {
        Long userId = Long.parseLong(loginId.toString());
        return permissionService.getPermissionCodesByUserId(userId);
    }

    /**
     * 返回用户拥有的角色码集合
     */
    @Override
    public List<String> getRoleList(Object loginId, String loginType) {
        Long userId = Long.parseLong(loginId.toString());
        return permissionService.getRoleCodesByUserId(userId);
    }
}
```

#### API 设计

```yaml
# ==================== 认证接口（无需登录）====================
POST /api/auth/register           # 用户注册
POST /api/auth/login              # 用户登录，返回 Token
POST /api/auth/logout             # 退出登录

# ==================== 用户接口（需登录）====================
GET  /api/users/me                # 获取当前用户信息
PUT  /api/users/me                # 更新当前用户信息

# 授权码激活（需权限：license:activate）
POST /api/users/me/licenses/activate   # 激活授权码绑定设备
  Body: { "code": "DKPT-XXXX-XXXX-XXXX", "deviceId": "device-001" }

GET  /api/users/me/licenses            # 我的授权码列表
GET  /api/users/me/devices             # 我的设备列表（通过授权码关联）

# ==================== 管理接口 ====================
# 授权码管理（需权限：license:*）
POST /api/admin/licenses/generate      # 批量生成授权码
  Body: { "count": 100, "batchNo": "2024-02-BATCH1", "expiresAt": null }

GET  /api/admin/licenses               # 授权码列表（支持筛选）
  Query: ?status=UNUSED&batchNo=xxx&page=0&size=20

PUT  /api/admin/licenses/{id}/revoke   # 撤销授权码
GET  /api/admin/licenses/export        # 导出授权码（CSV）

# 用户管理（需权限：user:*）
GET  /api/admin/users                  # 用户列表
GET  /api/admin/users/{id}             # 用户详情
PUT  /api/admin/users/{id}/status      # 启用/禁用用户
PUT  /api/admin/users/{id}/roles       # 分配角色

# 角色管理（需权限：role:*）
GET  /api/admin/roles                  # 角色列表
POST /api/admin/roles                  # 创建角色
PUT  /api/admin/roles/{id}             # 更新角色
PUT  /api/admin/roles/{id}/permissions # 分配权限

# 操作日志（需权限：log:list）
GET  /api/admin/logs                   # 操作日志查询
```

### 3.6 授权码激活流程

```java
@Service
@Transactional(rollbackFor = Exception.class)
public class LicenseCodeService {

    /**
     * 激活授权码
     *
     * @param userId   当前用户ID
     * @param code     授权码
     * @param deviceId 要绑定的设备ID
     */
    public LicenseCode activate(Long userId, String code, String deviceId) {
        // 1. 查找授权码
        LicenseCode license = licenseCodeRepository.findByCode(code)
            .orElseThrow(() -> new BusinessException(ErrorCode.LICENSE_NOT_FOUND, "授权码不存在"));

        // 2. 检查授权码状态
        if (license.getStatus() != LicenseStatus.UNUSED) {
            throw new BusinessException(ErrorCode.LICENSE_ALREADY_USED, "授权码已被使用");
        }

        // 3. 检查授权码是否过期
        if (license.getExpiresAt() != null && license.getExpiresAt().isBefore(Instant.now())) {
            throw new BusinessException(ErrorCode.LICENSE_EXPIRED, "授权码已过期");
        }

        // 4. 检查设备是否存在
        Device device = deviceRepository.findById(deviceId)
            .orElseThrow(() -> new BusinessException(ErrorCode.DEVICE_NOT_FOUND, "设备不存在"));

        // 5. 检查设备是否已被其他授权码绑定
        if (licenseCodeRepository.existsByDeviceIdAndStatus(deviceId, LicenseStatus.ACTIVATED)) {
            throw new BusinessException(ErrorCode.DEVICE_ALREADY_BOUND, "设备已被其他授权码绑定");
        }

        // 6. 激活授权码
        license.setStatus(LicenseStatus.ACTIVATED);
        license.setUserId(userId);
        license.setDeviceId(deviceId);
        license.setActivatedAt(Instant.now());

        // 7. 记录操作日志
        operationLogService.log(userId, deviceId, "ACTIVATE_LICENSE",
            Map.of("code", code));

        return licenseCodeRepository.save(license);
    }
}
```

### 3.7 权限控制示例（Sa-Token 注解）

```java
/**
 * 设备控制器 - 使用 Sa-Token 注解进行权限控制
 */
@RestController
@RequestMapping("/api/devices")
public class DeviceController {

    @Autowired
    private DeviceService deviceService;
    @Autowired
    private LicenseCodeService licenseCodeService;

    /**
     * 设备列表
     * - 管理员：查看所有设备
     * - 普通用户：只看自己授权码绑定的设备
     */
    @GetMapping
    @SaCheckLogin
    public List<DeviceResponse> listDevices() {
        long userId = StpUtil.getLoginIdAsLong();
        if (StpUtil.hasRole("ADMIN")) {
            return deviceService.listAll();
        }
        return licenseCodeService.findDevicesByUser(userId);
    }

    /**
     * 发送指令 - 需要 device:control 权限
     */
    @PostMapping("/{deviceId}/commands")
    @SaCheckPermission("device:control")
    public CommandResponse sendCommand(@PathVariable String deviceId,
                                       @RequestBody CommandCreateRequest request) {
        long userId = StpUtil.getLoginIdAsLong();

        // 非管理员需校验设备归属
        if (!StpUtil.hasRole("ADMIN") && !licenseCodeService.hasDevice(userId, deviceId)) {
            throw new BusinessException(ErrorCode.FORBIDDEN, "无权操作此设备");
        }

        // 记录操作日志
        operationLogService.log(userId, deviceId, "SEND_COMMAND", request);

        return commandService.send(deviceId, request);
    }
}

/**
 * 授权码管理控制器（管理员）
 */
@RestController
@RequestMapping("/api/admin/licenses")
public class AdminLicenseController {

    /**
     * 批量生成授权码 - 需要 license:generate 权限
     */
    @PostMapping("/generate")
    @SaCheckPermission("license:generate")
    public List<LicenseCodeResponse> generate(@RequestBody GenerateLicenseRequest request) {
        return licenseCodeService.generateBatch(request.getCount(), request.getBatchNo());
    }

    /**
     * 授权码列表 - 需要 license:list 权限
     */
    @GetMapping
    @SaCheckPermission("license:list")
    public Page<LicenseCodeResponse> list(LicenseQueryRequest query, Pageable pageable) {
        return licenseCodeService.list(query, pageable);
    }

    /**
     * 撤销授权码 - 需要 license:revoke 权限
     */
    @PutMapping("/{id}/revoke")
    @SaCheckPermission("license:revoke")
    public void revoke(@PathVariable Long id) {
        licenseCodeService.revoke(id);
    }

    /**
     * 导出授权码 - 需要 license:export 权限
     */
    @GetMapping("/export")
    @SaCheckPermission("license:export")
    public void export(HttpServletResponse response, LicenseQueryRequest query) {
        licenseCodeService.exportCsv(response, query);
    }
}
```

### 3.8 依赖添加

```xml
<!-- pet-core/pom.xml -->

<!-- Sa-Token 核心包 -->
<dependency>
    <groupId>cn.dev33</groupId>
    <artifactId>sa-token-spring-boot3-starter</artifactId>
    <version>1.37.0</version>
</dependency>

<!-- Sa-Token 整合 Redis（分布式会话） -->
<dependency>
    <groupId>cn.dev33</groupId>
    <artifactId>sa-token-redis-jackson</artifactId>
    <version>1.37.0</version>
</dependency>

<!-- Redis 连接池 -->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-pool2</artifactId>
</dependency>
```

### 3.9 Sa-Token 配置

```yaml
# application.yml

# Sa-Token 配置
sa-token:
  # Token 名称（同时也是 Cookie 名称）
  token-name: Authorization
  # Token 有效期（单位：秒），默认30天，-1代表永不过期
  timeout: 86400
  # Token 临时有效期（指定时间内无操作就视为过期），单位：秒
  active-timeout: -1
  # 是否允许同一账号并发登录（为 false 时新登录挤掉旧登录）
  is-concurrent: true
  # 在多人登录同一账号时，是否共用一个 Token
  is-share: false
  # Token 风格（uuid / simple-uuid / random-32 / random-64 / random-128 / tik）
  token-style: uuid
  # 是否输出操作日志
  is-log: true
  # 是否从 Header 读取 Token
  is-read-header: true
  # 是否从 Cookie 读取 Token
  is-read-cookie: false

# Redis 配置（用于分布式会话）
spring:
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    database: 0
```

### 3.10 全局异常处理

```java
@RestControllerAdvice
public class GlobalExceptionHandler {

    /**
     * Sa-Token 未登录异常
     */
    @ExceptionHandler(NotLoginException.class)
    public ErrorResponse handleNotLogin(NotLoginException e) {
        String message = switch (e.getType()) {
            case NotLoginException.NOT_TOKEN -> "未提供 Token";
            case NotLoginException.INVALID_TOKEN -> "Token 无效";
            case NotLoginException.TOKEN_TIMEOUT -> "Token 已过期";
            case NotLoginException.BE_REPLACED -> "已被顶下线";
            case NotLoginException.KICK_OUT -> "已被踢下线";
            default -> "未登录";
        };
        return ErrorResponse.of(401, message);
    }

    /**
     * Sa-Token 无权限异常
     */
    @ExceptionHandler(NotPermissionException.class)
    public ErrorResponse handleNotPermission(NotPermissionException e) {
        return ErrorResponse.of(403, "无权限: " + e.getPermission());
    }

    /**
     * Sa-Token 无角色异常
     */
    @ExceptionHandler(NotRoleException.class)
    public ErrorResponse handleNotRole(NotRoleException e) {
        return ErrorResponse.of(403, "无角色: " + e.getRole());
    }
}
```

---

## 四、V0.3 物模型管理

### 4.1 物模型数据结构

```sql
-- 产品/设备型号表（物模型挂载点）
CREATE TABLE product (
    id              BIGSERIAL PRIMARY KEY,
    product_key     VARCHAR(50) NOT NULL UNIQUE,   -- 产品标识（如：deskpet-v1）
    name            VARCHAR(100) NOT NULL,          -- 产品名称
    description     VARCHAR(500),
    status          VARCHAR(20) DEFAULT 'ACTIVE',   -- ACTIVE / DEPRECATED
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP
);

-- 物模型-属性定义
CREATE TABLE thing_model_property (
    id              BIGSERIAL PRIMARY KEY,
    product_key     VARCHAR(50) NOT NULL REFERENCES product(product_key),
    identifier      VARCHAR(50) NOT NULL,           -- 属性标识（如：battery）
    name            VARCHAR(100) NOT NULL,          -- 属性名称（如：电池电量）
    data_type       VARCHAR(20) NOT NULL,           -- int / float / bool / string / enum / struct
    specs           JSONB,                          -- 数据规格（范围、枚举值等）
    access_mode     VARCHAR(10) DEFAULT 'r',        -- r(只读) / rw(读写)
    required        BOOLEAN DEFAULT FALSE,
    description     VARCHAR(500),
    sort_order      INT DEFAULT 0,
    UNIQUE(product_key, identifier)
);

-- 物模型-服务/指令定义
CREATE TABLE thing_model_service (
    id              BIGSERIAL PRIMARY KEY,
    product_key     VARCHAR(50) NOT NULL REFERENCES product(product_key),
    identifier      VARCHAR(50) NOT NULL,           -- 服务标识（如：move）
    name            VARCHAR(100) NOT NULL,          -- 服务名称（如：移动控制）
    call_type       VARCHAR(20) DEFAULT 'async',    -- async(异步) / sync(同步)
    input_params    JSONB,                          -- 输入参数定义
    output_params   JSONB,                          -- 输出参数定义
    description     VARCHAR(500),
    sort_order      INT DEFAULT 0,
    UNIQUE(product_key, identifier)
);

-- 物模型-事件定义（新增）
CREATE TABLE thing_model_event (
    id              BIGSERIAL PRIMARY KEY,
    product_key     VARCHAR(50) NOT NULL REFERENCES product(product_key),
    identifier      VARCHAR(50) NOT NULL,           -- 事件标识（如：collision）
    name            VARCHAR(100) NOT NULL,          -- 事件名称（如：碰撞事件）
    event_type      VARCHAR(20) NOT NULL,           -- info / alert / error
    output_params   JSONB,                          -- 事件参数定义
    description     VARCHAR(500),
    sort_order      INT DEFAULT 0,
    UNIQUE(product_key, identifier)
);

-- 事件上报记录表
CREATE TABLE device_event (
    id              BIGSERIAL PRIMARY KEY,
    device_id       VARCHAR(64) NOT NULL,
    event_id        VARCHAR(50) NOT NULL,           -- 事件标识
    event_type      VARCHAR(20) NOT NULL,           -- info / alert / error
    params          JSONB,                          -- 事件参数
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_device_event_device ON device_event(device_id, created_at DESC);
CREATE INDEX idx_device_event_type ON device_event(event_type, created_at DESC);
```

### 4.2 物模型 JSON Schema 示例

```json
{
  "productKey": "deskpet-v1",
  "productName": "桌宠机器人V1",
  "properties": [
    {
      "identifier": "battery",
      "name": "电池电量",
      "dataType": "int",
      "specs": { "min": 0, "max": 100, "unit": "%" },
      "accessMode": "r",
      "required": true
    },
    {
      "identifier": "rssi",
      "name": "信号强度",
      "dataType": "int",
      "specs": { "min": -100, "max": 0, "unit": "dBm" },
      "accessMode": "r"
    },
    {
      "identifier": "brightness",
      "name": "屏幕亮度",
      "dataType": "int",
      "specs": { "min": 0, "max": 100, "unit": "%" },
      "accessMode": "rw"
    }
  ],
  "services": [
    {
      "identifier": "move",
      "name": "移动控制",
      "callType": "async",
      "inputParams": [
        { "identifier": "direction", "name": "方向", "dataType": "enum",
          "specs": { "values": ["forward", "backward", "left", "right"] } },
        { "identifier": "speed", "name": "速度", "dataType": "float",
          "specs": { "min": 0, "max": 1.0 } },
        { "identifier": "durationMs", "name": "持续时间", "dataType": "int",
          "specs": { "min": 0, "max": 5000, "unit": "ms" } }
      ],
      "outputParams": []
    },
    {
      "identifier": "setEmotion",
      "name": "设置表情",
      "callType": "async",
      "inputParams": [
        { "identifier": "emotion", "name": "表情", "dataType": "enum",
          "specs": { "values": ["happy", "sad", "angry", "sleepy", "idle"] } }
      ]
    },
    {
      "identifier": "speak",
      "name": "语音播报",
      "callType": "async",
      "inputParams": [
        { "identifier": "text", "name": "文本", "dataType": "string",
          "specs": { "maxLength": 200 } },
        { "identifier": "voice", "name": "音色", "dataType": "enum",
          "specs": { "values": ["default", "cute", "robot"] } }
      ]
    }
  ],
  "events": [
    {
      "identifier": "collision",
      "name": "碰撞事件",
      "eventType": "alert",
      "outputParams": [
        { "identifier": "direction", "name": "碰撞方向", "dataType": "enum",
          "specs": { "values": ["front", "back", "left", "right"] } },
        { "identifier": "intensity", "name": "碰撞强度", "dataType": "int",
          "specs": { "min": 0, "max": 100 } }
      ]
    },
    {
      "identifier": "touch",
      "name": "触摸事件",
      "eventType": "info",
      "outputParams": [
        { "identifier": "position", "name": "触摸位置", "dataType": "enum",
          "specs": { "values": ["head", "back", "belly"] } },
        { "identifier": "duration", "name": "触摸时长", "dataType": "int",
          "specs": { "unit": "ms" } }
      ]
    },
    {
      "identifier": "lowBattery",
      "name": "低电量告警",
      "eventType": "alert",
      "outputParams": [
        { "identifier": "level", "name": "当前电量", "dataType": "int",
          "specs": { "unit": "%" } }
      ]
    },
    {
      "identifier": "fall",
      "name": "跌落事件",
      "eventType": "error",
      "outputParams": [
        { "identifier": "height", "name": "跌落高度", "dataType": "float",
          "specs": { "unit": "cm" } }
      ]
    },
    {
      "identifier": "voiceWakeup",
      "name": "语音唤醒",
      "eventType": "info",
      "outputParams": [
        { "identifier": "keyword", "name": "唤醒词", "dataType": "string" },
        { "identifier": "confidence", "name": "置信度", "dataType": "float",
          "specs": { "min": 0, "max": 1.0 } }
      ]
    }
  ]
}
```

### 4.3 事件上报协议

设备通过 MQTT 上报事件到 Topic：`device/{deviceId}/event`

```json
{
  "eventId": "collision",
  "eventType": "alert",
  "timestamp": 1707200000000,
  "params": {
    "direction": "front",
    "intensity": 75
  }
}
```

### 4.4 pet-core 物模型相关类

```
com.deskpet.core
├── model/
│   ├── Product.java                  # 产品实体
│   ├── ThingModelProperty.java       # 属性定义
│   ├── ThingModelService.java        # 服务定义
│   ├── ThingModelEvent.java          # 事件定义
│   └── DeviceEvent.java              # 设备事件记录
├── repository/
│   ├── ProductRepository.java
│   ├── ThingModelPropertyRepository.java
│   ├── ThingModelServiceRepository.java
│   ├── ThingModelEventRepository.java
│   └── DeviceEventRepository.java
├── dto/
│   ├── ThingModelDTO.java            # 完整物模型DTO
│   ├── PropertyDTO.java
│   ├── ServiceDTO.java
│   ├── EventDTO.java
│   └── DeviceEventRequest.java       # 事件上报请求
├── service/
│   ├── ThingModelService.java        # 物模型CRUD
│   └── DeviceEventService.java       # 事件处理
└── controller/
    ├── ThingModelController.java     # 物模型管理API
    └── InternalController.java       # 新增事件上报接口
```

### 4.5 物模型管理 API

```yaml
# ==================== 物模型管理（需 ADMIN 角色）====================
# 产品管理
POST   /api/admin/products                    # 创建产品
GET    /api/admin/products                    # 产品列表
GET    /api/admin/products/{productKey}       # 产品详情（含完整物模型）
PUT    /api/admin/products/{productKey}       # 更新产品
DELETE /api/admin/products/{productKey}       # 删除产品

# 物模型-属性
POST   /api/admin/products/{productKey}/properties      # 添加属性
PUT    /api/admin/products/{productKey}/properties/{id} # 更新属性
DELETE /api/admin/products/{productKey}/properties/{id} # 删除属性

# 物模型-服务
POST   /api/admin/products/{productKey}/services        # 添加服务
PUT    /api/admin/products/{productKey}/services/{id}   # 更新服务
DELETE /api/admin/products/{productKey}/services/{id}   # 删除服务

# 物模型-事件
POST   /api/admin/products/{productKey}/events          # 添加事件
PUT    /api/admin/products/{productKey}/events/{id}     # 更新事件
DELETE /api/admin/products/{productKey}/events/{id}     # 删除事件

# 导入/导出
POST   /api/admin/products/{productKey}/import          # 导入物模型JSON
GET    /api/admin/products/{productKey}/export          # 导出物模型JSON

# ==================== 事件查询 ====================
GET    /api/devices/{deviceId}/events         # 设备事件历史
  Query: ?eventId=collision&eventType=alert&startTime=xxx&endTime=xxx

# ==================== 内部接口（网关调用）====================
POST   /internal/event/{deviceId}             # 事件上报
```

### 4.6 mqtt-gateway 事件转发

```java
// MqttServerVerticle.java 新增事件处理
private void handlePublish(String deviceId, MqttPublishMessage message) {
    String topic = message.topicName();

    if (topic.endsWith("/telemetry")) {
        forwardToCore("/internal/telemetry/", deviceId, message.payload());
    } else if (topic.endsWith("/ack")) {
        forwardToCore("/internal/ack/", deviceId, message.payload());
    } else if (topic.endsWith("/event")) {
        // 新增：事件上报
        forwardToCore("/internal/event/", deviceId, message.payload());
        metrics.onEvent();
    }
}
```

---

## 五、V0.4 前端分离

### 5.1 目录结构

```
deskpetConsole/
├── admin/                    # 管理后台
│   └── frontend/
│       ├── src/
│       │   ├── pages/
│       │   │   ├── Dashboard.vue         # 系统概览
│       │   │   ├── Users.vue             # 用户管理
│       │   │   ├── Licenses.vue          # 授权码管理（新增）
│       │   │   ├── Products.vue          # 产品管理（新增）
│       │   │   ├── ThingModel.vue        # 物模型编辑（新增）
│       │   │   ├── Devices.vue           # 全部设备
│       │   │   ├── Events.vue            # 事件查询（新增）
│       │   │   ├── Logs.vue              # 操作日志
│       │   │   └── Settings.vue          # 系统设置
│       │   └── ...
│       └── package.json
│
└── user/                     # 用户端（新增）
    └── frontend/
        ├── src/
        │   ├── pages/
        │   │   ├── Login.vue             # 登录
        │   │   ├── Register.vue          # 注册
        │   │   ├── ActivateLicense.vue   # 激活授权码（新增）
        │   │   ├── MyDevices.vue         # 我的设备
        │   │   ├── DeviceControl.vue     # 设备控制
        │   │   ├── DeviceTelemetry.vue   # 设备数据
        │   │   ├── DeviceEvents.vue      # 设备事件（新增）
        │   │   └── Profile.vue           # 个人中心
        │   ├── stores/
        │   │   └── auth.ts               # 登录状态管理
        │   └── utils/
        │       └── request.ts            # 带 JWT 的请求封装
        └── package.json
```

### 5.2 管理后台新增页面

| 页面 | 功能 |
|------|------|
| **授权码管理** | 批量生成、列表查询、导出CSV、撤销授权码 |
| **产品管理** | 产品CRUD、关联物模型 |
| **物模型编辑** | 可视化编辑属性/服务/事件定义，JSON导入导出 |
| **事件查询** | 按设备/事件类型/时间范围查询事件历史 |

### 5.3 用户端核心页面

| 页面 | 功能 |
|------|------|
| **登录/注册** | 用户认证，JWT 存储 |
| **激活授权码** | 输入授权码 + 设备ID 完成绑定 |
| **我的设备** | 设备列表、在线状态、基本信息 |
| **设备控制** | 移动控制、表情设置、AI对话 |
| **设备数据** | 实时遥测、历史图表 |
| **设备事件** | 查看设备上报的事件（碰撞、触摸等） |
| **个人中心** | 我的授权码、修改密码、退出登录 |

### 5.4 授权码激活流程（用户端）

```
┌─────────────────────────────────────────────────────────────────┐
│                     用户激活授权码流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Step 1: 用户登录/注册                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Step 2: 进入"激活授权码"页面                              │  │
│  │                                                          │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │  授权码: [DKPT-XXXX-XXXX-XXXX]                      │  │  │
│  │  │  设备ID: [device-001        ] (扫码或手动输入)       │  │  │
│  │  │                                                    │  │  │
│  │  │  [激活]                                            │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            ▼                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Step 3: 激活成功，设备出现在"我的设备"列表                 │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 六、V0.5 可观测性增强

### 6.1 时序数据库方案

**推荐：TimescaleDB（PostgreSQL 扩展）**

优势：
- 与现有 PostgreSQL 无缝集成
- 支持标准 SQL 查询
- 自动分区、压缩、数据保留策略
- 无需额外运维

```sql
-- 启用 TimescaleDB 扩展
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- 将 telemetry_history 转为超表
SELECT create_hypertable('telemetry_history', 'created_at',
    chunk_time_interval => INTERVAL '1 day',
    migrate_data => true
);

-- 设置数据保留策略（保留 30 天）
SELECT add_retention_policy('telemetry_history', INTERVAL '30 days');

-- 设置压缩策略（7天后压缩）
ALTER TABLE telemetry_history SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'device_id'
);
SELECT add_compression_policy('telemetry_history', INTERVAL '7 days');
```

### 6.2 操作日志增强

```sql
-- 操作日志也可转为超表
SELECT create_hypertable('operation_log', 'created_at',
    chunk_time_interval => INTERVAL '1 day'
);

-- 保留 90 天
SELECT add_retention_policy('operation_log', INTERVAL '90 days');
```

### 6.3 告警规则（Prometheus + Alertmanager）

```yaml
# prometheus/alert_rules.yml
groups:
  - name: deskpet
    rules:
      - alert: DeviceOffline
        expr: deskpet_gateway_online < 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "所有设备离线"

      - alert: HighAuthFailRate
        expr: rate(deskpet_gateway_auth_fail_total[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "认证失败率过高"

      - alert: CommandTimeout
        expr: rate(deskpet_core_command_timeout_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "指令超时率过高"
```

---

## 七、V0.6 行为与交互

### 7.1 行为状态机

```java
public enum PetState {
    IDLE,       // 空闲
    MOVING,     // 移动中
    PLAYING,    // 玩耍
    SLEEPING,   // 睡眠
    EATING,     // 进食
    ALERT       // 警觉
}

public enum PetEvent {
    TOUCH,          // 被触摸
    COLLISION,      // 碰撞
    LOW_BATTERY,    // 低电量
    VOICE_COMMAND,  // 语音指令
    TIMER,          // 定时器
    IDLE_TIMEOUT    // 空闲超时
}
```

### 7.2 定时卖萌

```java
@Scheduled(cron = "0 0 * * * *")  // 每小时
public void randomCuteAction() {
    List<Device> onlineDevices = deviceService.findOnline();
    for (Device device : onlineDevices) {
        String[] actions = {"wag_tail", "blink", "stretch", "yawn"};
        String action = actions[random.nextInt(actions.length)];
        commandService.send(device.deviceId(), action, Map.of());
    }
}
```

---

## 八、任务优先级建议

### 高优先级（V0.2 必做）

- [ ] RBAC 表结构设计与迁移脚本（用户、角色、权限、授权码）
- [ ] Sa-Token 集成与配置
- [ ] 用户注册/登录 API
- [ ] 权限数据加载实现（StpInterface）
- [ ] 授权码生成/激活 API
- [ ] 现有 API 权限改造（基于授权码关联 + Sa-Token 注解）

### 中优先级（V0.3）

- [ ] 产品表、物模型表设计与迁移
- [ ] 物模型 CRUD API
- [ ] 事件上报接口（mqtt-gateway + pet-core）
- [ ] 事件历史查询 API

### 中优先级（V0.4）

- [x] 前端管理后台：授权码管理页面
- [x] 前端管理后台：物模型编辑页面
- [x] 前端管理后台：产品列表页面
- [ ] 前端用户端项目初始化
- [ ] 用户端：登录/注册页面
- [ ] 用户端：激活授权码页面
- [ ] 用户端：我的设备/设备控制页面

### 低优先级（V0.5+）

- [ ] TimescaleDB 集成
- [ ] 操作日志持久化
- [ ] Alertmanager 告警
- [ ] 行为状态机
- [ ] 定时任务

---

## 九、技术选型建议

| 需求 | 推荐方案 | 备选方案 |
|------|----------|----------|
| 权限框架 | **Sa-Token** (轻量、国产) | Spring Security |
| 权限模型 | **RBAC** (用户-角色-权限) | ACL |
| 会话存储 | Redis (分布式) | 内存 (单机) |
| 时序数据库 | TimescaleDB | InfluxDB / QuestDB |
| 前端状态管理 | Pinia | Vuex |
| 移动端（未来） | uni-app / Flutter | React Native |
| 消息推送（未来） | WebSocket + STOMP | SSE |

---

## 十、里程碑时间线

```
V0.1 ✅ 已完成
  └── 设备接入、指令下发、遥测上报、管理控制台

V0.2 用户系统 + 授权码
  ├── 用户注册/登录
  ├── JWT 鉴权
  ├── 授权码生成/激活
  └── 权限控制

V0.3 物模型管理
  ├── 产品管理
  ├── 属性/服务/事件定义
  ├── 事件上报
  └── 物模型导入导出

V0.4 前端分离
  ├── 管理后台增强（授权码、产品、物模型）✅ 已完成
  ├── 用户端 App（进行中）
  └── 操作日志

V0.5 可观测性
  ├── TimescaleDB
  ├── 告警系统
  └── 数据分析

V0.6 行为交互
  ├── 状态机
  ├── 定时任务
  └── 事件触发
```

---

## 十一、附录：授权码业务规则

### 11.1 核心约束

| 规则 | 说明 |
|------|------|
| **一码一机** | 一个授权码只能绑定一个设备 |
| **一机一码** | 一个设备只能被一个授权码绑定 |
| **不可转移** | 授权码激活后不可解绑（可由管理员撤销） |
| **可设过期** | 支持限时授权（可选） |

### 11.2 授权码状态流转

```
┌─────────┐     激活      ┌───────────┐
│  UNUSED │ ────────────► │ ACTIVATED │
└─────────┘               └───────────┘
     │                          │
     │ 撤销                     │ 撤销
     ▼                          ▼
┌─────────┐               ┌───────────┐
│ REVOKED │ ◄──────────── │  REVOKED  │
└─────────┘               └───────────┘
```

### 11.3 管理员操作

| 操作 | 说明 |
|------|------|
| **批量生成** | 生成指定数量授权码，可设批次号便于管理 |
| **导出CSV** | 导出授权码列表，用于印刷卡片或发货 |
| **撤销授权** | 撤销已激活的授权码（设备解绑） |
| **查询统计** | 按批次、状态统计授权码使用情况 |

### 11.4 授权码卡片示例

```
┌─────────────────────────────────────┐
│                                     │
│         🐾 DeskPet 桌宠             │
│                                     │
│    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │
│                                     │
│    授权码：DKPT-A3B7-K9M2-X4N8     │
│                                     │
│    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━    │
│                                     │
│    使用说明：                        │
│    1. 下载 DeskPet App              │
│    2. 注册/登录账号                  │
│    3. 输入授权码和设备ID激活         │
│                                     │
│    客服：support@deskpet.com        │
│                                     │
└─────────────────────────────────────┘
```

---

## 十二、附录：Sa-Token 简介

### 12.1 为什么选择 Sa-Token

| 对比项 | Sa-Token | Spring Security |
|--------|----------|-----------------|
| **学习成本** | 低，API 简洁直观 | 高，概念多、配置复杂 |
| **代码量** | 少，注解驱动 | 多，需大量配置类 |
| **功能完整性** | 登录/权限/Session/SSO/OAuth2 | 需整合多个模块 |
| **中文文档** | 完善，国产框架 | 官方英文为主 |
| **性能** | 轻量高效 | 相对较重 |
| **适用场景** | 中小型项目、快速开发 | 大型企业级项目 |

### 12.2 Sa-Token 核心功能

```java
// 登录
StpUtil.login(userId);

// 获取当前登录用户ID
long userId = StpUtil.getLoginIdAsLong();

// 判断是否登录
StpUtil.isLogin();

// 注销
StpUtil.logout();

// 权限校验
StpUtil.checkPermission("device:control");
StpUtil.checkRole("ADMIN");

// 注解方式（推荐）
@SaCheckLogin                           // 需要登录
@SaCheckRole("ADMIN")                   // 需要角色
@SaCheckPermission("device:control")    // 需要权限
@SaCheckPermission(value = {"a", "b"}, mode = SaMode.OR)  // 满足其一
```

### 12.3 Sa-Token 官方资源

- 官网：https://sa-token.cc
- GitHub：https://github.com/dromara/sa-token
- 文档：https://sa-token.cc/doc.html
