# 任务进度

## 已完成（V0.1）
1. 初始化多模块 Maven 结构（pet-core、mqtt-gateway），包含基础依赖与构建配置。
2. pet-core：实现设备注册/查询、指令下发与状态机、遥测接收、网关回调接口（内存存储 + 超时扫描）。
3. mqtt-gateway：实现 MQTT 接入、认证、Topic ACL、上行转发、下行 HTTP 接口与在线离线回调。
4. 下发命令协议对齐：统一命令信封格式，修复遥测字段空值处理。
5. 内部接口鉴权：网关与 Core 支持可选 internal token 校验。
6. 日志框架接入：mqtt-gateway 接入 log4j2，pet-core 使用 logback，替换 System 输出为标准日志。
7. 设备密钥加密存储（hash + 盐），补充注册与鉴权流程。
8. pet-core 接入 PostgreSQL + Flyway，完成设备/会话/指令/遥测持久化表结构与迁移脚本。
9. 遥测 latest + 历史持久化落地（JSONB 存储）。
10. 可观测性部署模板（Prometheus + Grafana）与文档补充。

## 已完成（V0.2）用户系统 + 授权码

### 核心功能
- [x] RBAC 权限模型设计（用户-角色-权限三层结构）
- [x] Sa-Token 权限框架集成（替代 Spring Security）
- [x] Sa-Token + Redis 分布式会话管理
- [x] 用户注册/登录/退出 API
- [x] 授权码生成/激活/撤销/导出功能
- [x] 权限数据加载实现（StpInterfaceImpl）
- [x] 现有 API 权限改造（DeviceController、CommandController）
- [x] 操作日志异步记录

### 数据库迁移
- [x] V2__user_rbac_license.sql
  - sys_user（用户表）
  - sys_role（角色表）
  - sys_permission（权限表）
  - sys_user_role（用户-角色关联）
  - sys_role_permission（角色-权限关联）
  - license_code（授权码表）
  - operation_log（操作日志表）
  - 初始化角色：ADMIN、USER、OPERATOR
  - 初始化权限：用户管理、角色管理、授权码管理、设备管理、产品管理、日志管理
  - 默认管理员：admin / admin123

### 新增实体类
- SysUser、SysRole、SysPermission
- LicenseCode（授权码）
- OperationLog（操作日志）

### 新增 Repository
- SysUserRepository（含角色/权限 fetch join 查询）
- SysRoleRepository
- SysPermissionRepository（原生 SQL 查询）
- LicenseCodeRepository
- OperationLogRepository

### 新增 Service
- UserService（注册、登录、退出、用户管理）
- LicenseCodeService（授权码生成、激活、撤销、导出）
- PermissionService（权限/角色查询，供 Sa-Token 使用）
- OperationLogService（异步操作日志记录）

### 新增 Controller
- AuthController：POST /api/auth/register, /api/auth/login, /api/auth/logout
- UserController：GET/PUT /api/users/me, 授权码激活, 我的设备
- AdminLicenseController：授权码管理（生成、列表、撤销、导出）
- AdminUserController：用户管理（列表、状态更新）
- AdminLogController：操作日志查询

### 配置更新
- SaTokenConfig：拦截器配置，排除公开接口
- StpInterfaceImpl：Sa-Token 权限数据加载
- application.yml：Sa-Token + Redis 配置
- pom.xml：Sa-Token、Redis、BCrypt 依赖

### 工具类
- PasswordUtil：BCrypt 密码加密（使用 favre BCrypt 库）
- LicenseCodeGenerator：授权码生成器（DKPT-XXXX-XXXX-XXXX 格式）

### API 端点汇总

```
# 认证接口（无需登录）
POST /api/auth/register           # 用户注册
POST /api/auth/login              # 用户登录
POST /api/auth/logout             # 退出登录

# 用户接口（需登录）
GET  /api/users/me                # 获取当前用户信息
PUT  /api/users/me                # 更新当前用户信息
POST /api/users/me/licenses/activate  # 激活授权码
GET  /api/users/me/licenses       # 我的授权码列表
GET  /api/users/me/devices        # 我的设备列表

# 管理接口
POST /api/admin/licenses/generate # 批量生成授权码
GET  /api/admin/licenses          # 授权码列表
PUT  /api/admin/licenses/{id}/revoke  # 撤销授权码
GET  /api/admin/licenses/export   # 导出授权码（CSV）
GET  /api/admin/licenses/batch/{batchNo}/stats  # 批次统计

GET  /api/admin/users             # 用户列表
GET  /api/admin/users/{id}        # 用户详情
PUT  /api/admin/users/{id}/status # 更新用户状态

GET  /api/admin/logs              # 操作日志查询
```

---

## 已完成（V0.3）物模型管理

### 核心功能
- [x] 产品/设备型号管理
- [x] 物模型定义（属性、服务、事件）
- [x] 事件上报接口（mqtt-gateway + pet-core）
- [x] 事件历史查询 API
- [x] 物模型导入/导出

### 数据库迁移
- [x] V3__thing_model.sql
  - product（产品表）
  - thing_model_property（属性定义）
  - thing_model_service（服务定义）
  - thing_model_event（事件定义）
  - device_event（设备事件记录）
  - 初始化默认产品 deskpet-v1 及完整物模型

### 新增实体类
- Product（产品）
- ThingModelProperty（属性定义）
- ThingModelService（服务定义）
- ThingModelEvent（事件定义）
- DeviceEvent（设备事件记录）

### 新增 Repository
- ProductRepository（含物模型 fetch join 查询）
- ThingModelPropertyRepository
- ThingModelServiceRepository
- ThingModelEventRepository
- DeviceEventRepository

### 新增 Service
- ProductService（产品 CRUD、物模型管理、导入导出）
- DeviceEventService（事件记录、查询、统计）

### 新增 Controller
- AdminProductController：产品与物模型管理 API

### 新增 DTO
- ProductCreateRequest / ProductUpdateRequest / ProductResponse
- PropertyCreateRequest / PropertyDTO
- ServiceCreateRequest / ServiceDTO
- EventCreateRequest / EventDTO
- ThingModelDTO（完整物模型）
- DeviceEventRequest / DeviceEventResponse

### 更新内容
- InternalController：新增 /internal/event/{deviceId} 事件上报接口
- DeviceController：新增设备事件查询和统计接口
- ErrorCode：新增产品/物模型相关错误码
- MqttServerVerticle：支持 pet/{deviceId}/event Topic 转发
- GatewayMetrics：新增事件计数器

### API 端点汇总

```
# 产品管理（需 ADMIN 角色）
POST   /api/admin/products                    # 创建产品
GET    /api/admin/products                    # 产品列表
GET    /api/admin/products/{productKey}       # 产品详情（含完整物模型）
PUT    /api/admin/products/{productKey}       # 更新产品
DELETE /api/admin/products/{productKey}       # 删除产品

# 物模型-属性
POST   /api/admin/products/{productKey}/properties      # 添加属性
PUT    /api/admin/products/{productKey}/properties/{id} # 更新属性
DELETE /api/admin/products/{productKey}/properties/{id} # 删除属性

# 物模型-服务
POST   /api/admin/products/{productKey}/services        # 添加服务
PUT    /api/admin/products/{productKey}/services/{id}   # 更新服务
DELETE /api/admin/products/{productKey}/services/{id}   # 删除服务

# 物模型-事件
POST   /api/admin/products/{productKey}/events          # 添加事件
PUT    /api/admin/products/{productKey}/events/{id}     # 更新事件
DELETE /api/admin/products/{productKey}/events/{id}     # 删除事件

# 导入/导出
GET    /api/admin/products/{productKey}/export          # 导出物模型JSON
POST   /api/admin/products/{productKey}/import          # 导入物模型JSON

# 设备事件查询
GET    /api/devices/{deviceId}/events                   # 设备事件历史
GET    /api/devices/{deviceId}/events/stats             # 设备事件统计

# 内部接口（网关调用）
POST   /internal/event/{deviceId}                       # 事件上报
```

### MQTT Topic
- 事件上报：`pet/{deviceId}/event`
- 消息格式：
```json
{
  "eventId": "collision",
  "eventType": "alert",
  "timestamp": 1707200000000,
  "params": {
    "direction": "front",
    "intensity": 75
  }
}
```

---

## 已完成（V0.4 管理后台增强）

### 前端管理后台
- [x] 授权码管理页面（分页列表、状态筛选、批次搜索、批量生成弹窗、撤销确认、CSV 导出）
- [x] 产品列表页面（产品 CRUD、创建/编辑弹窗、删除确认）
- [x] 物模型编辑页面（属性/服务/事件三 Tab CRUD、JSON 导入导出）
- [x] TypeScript 类型定义（license.ts、product.ts）
- [x] API 层封装（license.ts、product.ts）
- [x] 路由配置（/licenses、/products、/products/:productKey）
- [x] 侧边栏导航新增「授权码」和「产品」入口

### 新增文件
- `src/types/license.ts` — 授权码相关 TS 类型
- `src/types/product.ts` — 产品与物模型 TS 类型
- `src/api/license.ts` — 授权码管理 API
- `src/api/product.ts` — 产品与物模型 API
- `src/pages/Licenses.vue` — 授权码管理页面
- `src/pages/Products.vue` — 产品列表页面
- `src/pages/ThingModel.vue` — 物模型编辑页面

### 修改文件
- `src/router/index.ts` — 新增三条路由
- `src/App.vue` — 侧边栏导航新增两个入口

---

## 进行中

### V0.4 用户端
- [ ] 用户端项目初始化
- [ ] 用户端：登录/注册页面
- [ ] 用户端：激活授权码页面
- [ ] 用户端：我的设备列表
- [ ] 用户端：设备控制页面

### V0.5 可观测性增强
- [ ] TimescaleDB 集成
- [ ] 操作日志持久化优化
- [ ] Alertmanager 告警规则

### V0.6 行为与交互
- [ ] 行为状态机
- [ ] 定时卖萌
- [ ] 事件触发响应
