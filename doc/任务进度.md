# 任务进度

## 已完成（V0.1）
1. 初始化多模块 Maven 结构（pet-core、mqtt-gateway），包含基础依赖与构建配置。
2. pet-core：实现设备注册/查询、指令下发与状态机、遥测接收、网关回调接口（内存存储 + 超时扫描）。
3. mqtt-gateway：实现 MQTT 接入、认证、Topic ACL、上行转发、下行 HTTP 接口与在线离线回调。
4. 下发命令协议对齐：统一命令信封格式，修复遥测字段空值处理。
5. 内部接口鉴权：网关与 Core 支持可选 internal token 校验。
6. 日志框架接入：mqtt-gateway 接入 log4j2，pet-core 使用 logback，替换 System 输出为标准日志。
7. 设备密钥加密存储（hash + 盐），补充注册与鉴权流程。
8. pet-core 接入 PostgreSQL + Flyway，完成设备/会话/指令/遥测持久化表结构与迁移脚本。
9. 遥测 latest + 历史持久化落地（JSONB 存储）。
10. 可观测性部署模板（Prometheus + Grafana）与文档补充。

## 已完成（V0.2）用户系统 + 授权码

### 核心功能
- [x] RBAC 权限模型设计（用户-角色-权限三层结构）
- [x] Sa-Token 权限框架集成（替代 Spring Security）
- [x] Sa-Token + Redis 分布式会话管理
- [x] 用户注册/登录/退出 API
- [x] 授权码生成/激活/撤销/导出功能
- [x] 权限数据加载实现（StpInterfaceImpl）
- [x] 现有 API 权限改造（DeviceController、CommandController）
- [x] 操作日志异步记录

### 数据库迁移
- [x] V2__user_rbac_license.sql
  - sys_user（用户表）
  - sys_role（角色表）
  - sys_permission（权限表）
  - sys_user_role（用户-角色关联）
  - sys_role_permission（角色-权限关联）
  - license_code（授权码表）
  - operation_log（操作日志表）
  - 初始化角色：ADMIN、USER、OPERATOR
  - 初始化权限：用户管理、角色管理、授权码管理、设备管理、产品管理、日志管理
  - 默认管理员：admin / admin123

### 新增实体类
- SysUser、SysRole、SysPermission
- LicenseCode（授权码）
- OperationLog（操作日志）

### 新增 Repository
- SysUserRepository（含角色/权限 fetch join 查询）
- SysRoleRepository
- SysPermissionRepository（原生 SQL 查询）
- LicenseCodeRepository
- OperationLogRepository

### 新增 Service
- UserService（注册、登录、退出、用户管理）
- LicenseCodeService（授权码生成、激活、撤销、导出）
- PermissionService（权限/角色查询，供 Sa-Token 使用）
- OperationLogService（异步操作日志记录）

### 新增 Controller
- AuthController：POST /api/auth/register, /api/auth/login, /api/auth/logout
- UserController：GET/PUT /api/users/me, 授权码激活, 我的设备
- AdminLicenseController：授权码管理（生成、列表、撤销、导出）
- AdminUserController：用户管理（列表、状态更新）
- AdminLogController：操作日志查询

### 配置更新
- SaTokenConfig：拦截器配置，排除公开接口
- StpInterfaceImpl：Sa-Token 权限数据加载
- application.yml：Sa-Token + Redis 配置
- pom.xml：Sa-Token、Redis、BCrypt 依赖

### 工具类
- PasswordUtil：BCrypt 密码加密（使用 favre BCrypt 库）
- LicenseCodeGenerator：授权码生成器（DKPT-XXXX-XXXX-XXXX 格式）

### API 端点汇总

```
# 认证接口（无需登录）
POST /api/auth/register           # 用户注册
POST /api/auth/login              # 用户登录
POST /api/auth/logout             # 退出登录

# 用户接口（需登录）
GET  /api/users/me                # 获取当前用户信息
PUT  /api/users/me                # 更新当前用户信息
POST /api/users/me/licenses/activate  # 激活授权码
GET  /api/users/me/licenses       # 我的授权码列表
GET  /api/users/me/devices        # 我的设备列表

# 管理接口
POST /api/admin/licenses/generate # 批量生成授权码
GET  /api/admin/licenses          # 授权码列表
PUT  /api/admin/licenses/{id}/revoke  # 撤销授权码
GET  /api/admin/licenses/export   # 导出授权码（CSV）
GET  /api/admin/licenses/batch/{batchNo}/stats  # 批次统计

GET  /api/admin/users             # 用户列表
GET  /api/admin/users/{id}        # 用户详情
PUT  /api/admin/users/{id}/status # 更新用户状态

GET  /api/admin/logs              # 操作日志查询
```

---

## 已完成（V0.3）物模型管理

### 核心功能
- [x] 产品/设备型号管理
- [x] 物模型定义（属性、服务、事件）
- [x] 事件上报接口（mqtt-gateway + pet-core）
- [x] 事件历史查询 API
- [x] 物模型导入/导出

### 数据库迁移
- [x] V3__thing_model.sql
  - product（产品表）
  - thing_model_property（属性定义）
  - thing_model_service（服务定义）
  - thing_model_event（事件定义）
  - device_event（设备事件记录）
  - 初始化默认产品 deskpet-v1 及完整物模型

### 新增实体类
- Product（产品）
- ThingModelProperty（属性定义）
- ThingModelService（服务定义）
- ThingModelEvent（事件定义）
- DeviceEvent（设备事件记录）

### 新增 Repository
- ProductRepository（含物模型 fetch join 查询）
- ThingModelPropertyRepository
- ThingModelServiceRepository
- ThingModelEventRepository
- DeviceEventRepository

### 新增 Service
- ProductService（产品 CRUD、物模型管理、导入导出）
- DeviceEventService（事件记录、查询、统计）

### 新增 Controller
- AdminProductController：产品与物模型管理 API

### 新增 DTO
- ProductCreateRequest / ProductUpdateRequest / ProductResponse
- PropertyCreateRequest / PropertyDTO
- ServiceCreateRequest / ServiceDTO
- EventCreateRequest / EventDTO
- ThingModelDTO（完整物模型）
- DeviceEventRequest / DeviceEventResponse

### 更新内容
- InternalController：新增 /internal/event/{deviceId} 事件上报接口
- DeviceController：新增设备事件查询和统计接口
- ErrorCode：新增产品/物模型相关错误码
- MqttServerVerticle：支持 pet/{deviceId}/event Topic 转发
- GatewayMetrics：新增事件计数器

### API 端点汇总

```
# 产品管理（需 ADMIN 角色）
POST   /api/admin/products                    # 创建产品
GET    /api/admin/products                    # 产品列表
GET    /api/admin/products/{productKey}       # 产品详情（含完整物模型）
PUT    /api/admin/products/{productKey}       # 更新产品
DELETE /api/admin/products/{productKey}       # 删除产品

# 物模型-属性
POST   /api/admin/products/{productKey}/properties      # 添加属性
PUT    /api/admin/products/{productKey}/properties/{id} # 更新属性
DELETE /api/admin/products/{productKey}/properties/{id} # 删除属性

# 物模型-服务
POST   /api/admin/products/{productKey}/services        # 添加服务
PUT    /api/admin/products/{productKey}/services/{id}   # 更新服务
DELETE /api/admin/products/{productKey}/services/{id}   # 删除服务

# 物模型-事件
POST   /api/admin/products/{productKey}/events          # 添加事件
PUT    /api/admin/products/{productKey}/events/{id}     # 更新事件
DELETE /api/admin/products/{productKey}/events/{id}     # 删除事件

# 导入/导出
GET    /api/admin/products/{productKey}/export          # 导出物模型JSON
POST   /api/admin/products/{productKey}/import          # 导入物模型JSON

# 设备事件查询
GET    /api/devices/{deviceId}/events                   # 设备事件历史
GET    /api/devices/{deviceId}/events/stats             # 设备事件统计

# 内部接口（网关调用）
POST   /internal/event/{deviceId}                       # 事件上报
```

### MQTT Topic
- 事件上报：`pet/{deviceId}/event`
- 消息格式：
```json
{
  "eventId": "collision",
  "eventType": "alert",
  "timestamp": 1707200000000,
  "params": {
    "direction": "front",
    "intensity": 75
  }
}
```

---

## 已完成（V0.4 管理后台增强）

### 前端管理后台
- [x] 授权码管理页面（分页列表、状态筛选、批次搜索、批量生成弹窗、撤销确认、CSV 导出）
- [x] 产品列表页面（产品 CRUD、创建/编辑弹窗、删除确认）
- [x] 物模型编辑页面（属性/服务/事件三 Tab CRUD、JSON 导入导出）
- [x] TypeScript 类型定义（license.ts、product.ts）
- [x] API 层封装（license.ts、product.ts）
- [x] 路由配置（/licenses、/products、/products/:productKey）
- [x] 侧边栏导航新增「授权码」和「产品」入口

### 新增文件
- `src/types/license.ts` — 授权码相关 TS 类型
- `src/types/product.ts` — 产品与物模型 TS 类型
- `src/api/license.ts` — 授权码管理 API
- `src/api/product.ts` — 产品与物模型 API
- `src/pages/Licenses.vue` — 授权码管理页面
- `src/pages/Products.vue` — 产品列表页面
- `src/pages/ThingModel.vue` — 物模型编辑页面

### 修改文件
- `src/router/index.ts` — 新增三条路由
- `src/App.vue` — 侧边栏导航新增两个入口

---

## 进行中

### V0.4 用户端
- [x] 用户端项目初始化
- [x] 用户端：登录/注册页面
- [x] 用户端：激活授权码页面
- [x] 用户端：我的设备列表
- [x] 用户端：设备控制页面

### V0.5 可观测性增强
- [x] TimescaleDB 集成（独立时序库实例，双写架构）
- [x] logback 日志录入时序库（自定义 TimescaleDbAppender，异步批量写入）
- [x] 操作日志持久化优化（双写到 TimescaleDB，支持时序查询）
- [x] 设备交互数据录入时序库（遥测、事件、指令双写）
- [x] 设备上下线历史录入时序库（新增 ts_device_session 表）

### V0.5 WebSocket 实时推送
- [x] Spring WebSocket + STOMP 集成
- [x] WebSocket 握手认证拦截器（Sa-Token STOMP CONNECT 验证）
- [x] SaTokenConfig 排除 /ws/** 路径
- [x] WebSocketPushService 推送服务（指令状态 + 设备上下线）
- [x] CommandService 集成推送（handleAck、timeoutScan、dispatchCommand）
- [x] DeviceService 集成推送（markOnline、markOffline）
- [x] user-frontend WebSocket composable + DeviceControl.vue 改造（移除轮询）
- [x] manager WebSocket composable + Commands.vue 改造（自动刷新状态）
- [x] 两个前端项目安装 @stomp/stompjs + sockjs-client 依赖
- [x] Vite proxy 配置 /ws WebSocket 代理

#### 新增文件
- `pet-core/.../config/WebSocketConfig.java` — STOMP + WebSocket 配置
- `pet-core/.../config/WebSocketAuthInterceptor.java` — STOMP CONNECT 认证
- `pet-core/.../service/WebSocketPushService.java` — 推送服务
- `user-frontend/src/composables/useWebSocket.ts` — 用户端 WebSocket composable
- `manager/src/composables/useWebSocket.ts` — 管理端 WebSocket composable

#### 修改文件
- `pet-core/pom.xml` — 新增 spring-boot-starter-websocket 依赖
- `pet-core/.../config/SaTokenConfig.java` — 排除 /ws/**
- `pet-core/.../service/CommandService.java` — 状态变更时推送
- `pet-core/.../service/DeviceService.java` — 上下线时推送
- `user-frontend/src/pages/DeviceControl.vue` — 移除轮询，接入 WebSocket
- `user-frontend/src/api/device.ts` — 修复 API 路径
- `user-frontend/src/api/command.ts` — 修复 API 路径
- `user-frontend/vite.config.ts` — 新增 /ws 代理
- `manager/src/pages/Commands.vue` — 接入 WebSocket 自动刷新
- `manager/vite.config.ts` — 新增 /ws 代理

#### WebSocket Topic
```
/topic/device/{deviceId}/command-status   # 指令状态变更推送
/topic/device/{deviceId}/presence         # 设备上下线推送
```

#### 架构设计
- 保留现有 PostgreSQL 作为业务主库，新增独立 TimescaleDB 实例作为时序库
- 通过 `@ConditionalOnProperty(timescaledb.enabled=true)` 控制时序功能开关
- 时序写入全部异步（`@Async`），不影响主业务性能
- 各 Service 通过 `@Autowired(required = false)` 可选注入 TimeSeriesService

#### 部署变更
- Docker Compose 新增 TimescaleDB 服务（端口 5433）
- 初始化脚本 `deploy/timescaledb-init.sql` 自动挂载执行
- TimescaleDB 镜像：`timescale/timescaledb:latest-pg16`

#### 时序表（TimescaleDB，schema: deskpet_ts）
- `ts_telemetry` — 遥测历史（hypertable，7天分片，90天保留）
- `ts_device_event` — 设备事件（hypertable，7天分片，180天保留）
- `ts_device_session` — 设备上下线历史（hypertable，7天分片，90天保留）
- `ts_device_command` — 指令记录（hypertable，7天分片，90天保留）
- `ts_operation_log` — 操作日志（hypertable，30天分片，365天保留）
- `ts_app_log` — 应用日志（hypertable，1天分片，30天保留）
- 所有表均配置自动压缩策略

#### 新增文件
- `pet-core/.../config/TimescaleDbConfig.java` — 时序库数据源配置
- `pet-core/.../service/TimeSeriesService.java` — 时序数据写入与查询服务
- `pet-core/.../logging/TimescaleDbAppender.java` — Logback 自定义 Appender
- `deploy/timescaledb-init.sql` — TimescaleDB 初始化脚本

#### 修改文件
- `deploy/docker-compose.yml` — 新增 tsdb 服务
- `pet-core/pom.xml` — 新增 janino 依赖（logback 条件判断）
- `pet-core/.../resources/application.yml` — 新增 timescaledb 配置段
- `pet-core/.../resources/logback-spring.xml` — 新增 TSDB Appender
- `pet-core/.../service/TelemetryService.java` — 遥测双写
- `pet-core/.../service/DeviceEventService.java` — 事件双写
- `pet-core/.../service/DeviceService.java` — 上下线历史双写
- `pet-core/.../service/CommandService.java` — 指令双写
- `pet-core/.../service/OperationLogService.java` — 操作日志双写
- `pet-core/.../controller/DeviceController.java` — 新增上下线历史查询 API

#### 新增 API 端点
```
GET /api/devices/{deviceId}/sessions        # 设备上下线历史
GET /api/devices/{deviceId}/sessions/stats   # 设备上下线统计
```

#### 配置项
```yaml
timescaledb:
  enabled: true                    # 启用时序库（默认 false）
  datasource:
    url: jdbc:postgresql://localhost:5433/deskpet_ts
    username: deskpet
    password: deskpet
  log-level: WARN                  # Logback 录入级别（WARN/INFO/DEBUG）
```
