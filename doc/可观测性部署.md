# 可观测性部署（Prometheus + Grafana）

## 1. 启用网关指标输出

编辑 `mqtt-gateway` 配置（建议外置配置文件）：

```yaml
metrics:
  enabled: true
  path: "/metrics"
```

重启 `mqtt-gateway`，确认指标可访问：

```bash
curl http://localhost:8081/metrics
```

## 2. 启动 Prometheus + Grafana

```bash
docker compose -f deploy/observability/docker-compose.yml up -d
```

访问：
- Prometheus：`http://localhost:9090`
- Grafana：`http://localhost:3000`（默认账号密码：admin / admin）

## 3. 配置 Prometheus 抓取目标

默认配置文件在 `deploy/observability/prometheus.yml`，当前默认抓取：

```
host.docker.internal:8081
```

按运行方式修改：

- **网关在宿主机（Windows/Mac）**：保持默认即可  
- **网关在 Docker 内同网络**：改为容器名，如 `mqtt-gateway:8081`  
- **Linux 宿主机**：可替换为宿主机 IP，或在 compose 中加入 `extra_hosts` 绑定 `host.docker.internal`

修改后重启 Prometheus：

```bash
docker compose -f deploy/observability/docker-compose.yml restart prometheus
```

## 4. Grafana 数据源

已通过 provisioning 预置 Prometheus 数据源：

```
http://prometheus:9090
```

打开 Grafana 后可直接创建 Dashboard。

## 4.1 预置 Dashboard

已内置一个网关 Dashboard（Deskpet Gateway Overview），Grafana 启动后自动加载到 `Deskpet` 文件夹中。

如需修改图表或新增指标，可编辑：

```
deploy/observability/grafana/provisioning/dashboards/deskpet-gateway.json
```

## 5. 常用 PromQL 示例

```promql
deskpet_gateway_online
rate(deskpet_gateway_telemetry_total[1m])
rate(deskpet_gateway_ack_total[1m])
rate(deskpet_gateway_command_send_total[1m])
rate(deskpet_gateway_callback_fail_total[1m])
rate(deskpet_gateway_auth_fail_total[1m])
```

## 6. 安全建议

- `/metrics` 建议仅内网访问或通过网关层做访问控制。
