# 开发文档

适用范围：DeskPet V0.5

---

## 1. 版本目标

| 版本 | 目标 | 状态 |
| --- | --- | --- |
| V0.1 | 设备上线 + 下发移动/停止/表情 + 回执闭环 + 遥测上报 | ✅ 已完成 |
| V0.2 | 用户系统 + RBAC 权限 + 授权码管理 | ✅ 已完成 |
| V0.3 | 物模型管理 + 事件上报 | ✅ 已完成 |
| V0.4 | 前端分离（管理后台增强 + 用户端） | ✅ 已完成 |
| V0.5 | 可观测性增强（TimescaleDB）+ WebSocket 实时推送 | ✅ 已完成 |
| V0.6 | 行为与交互（状态机 + 定时卖萌） | 计划中 |

---

## 2. 仓库结构

```
deskpet/
  doc/                     # 文档目录
    MQTT通讯文档.md
    物模型文档.md
    对外API文档.md
    错误码文档.md
    部署与运维.md
    开发文档.md
    任务进度.md
  mqtt-gateway/            # Vert.x MQTT 网关
  pet-core/                # Spring Boot 核心服务
  pet-ai/                  # Spring Boot + Spring AI（后期）
  deskpetConsole/          # 管理后台前端（V0.4）
  deploy/                  # 部署配置
    docker-compose.yml
  scripts/                 # 脚本工具
```

---

## 3. 技术栈

### 3.1 后端技术栈

| 模块 | 技术 | 说明 |
| --- | --- | --- |
| mqtt-gateway | Vert.x 4.x | MQTT Server + HTTP Server |
| pet-core | Spring Boot 3.x | REST API + JPA |
| 数据库 | PostgreSQL 15+ | 主数据库 |
| 缓存 | Redis 7+ | 会话存储（Sa-Token） |
| 权限框架 | Sa-Token | 认证授权 |
| 实时通信 | Spring WebSocket + STOMP | 指令状态推送、设备上下线推送 |
| 数据库迁移 | Flyway | 版本化迁移 |
| API 文档 | SpringDoc OpenAPI | Swagger UI |

### 3.2 基础约定

| 约定 | 说明 |
| --- | --- |
| deviceId | 设备唯一标识，与 MQTT clientId/username 一致 |
| reqId | 指令唯一标识（UUID），用于幂等、追踪、审计 |
| schemaVersion | 协议版本，当前为 1 |
| 时间戳 | 指令/回执/遥测使用秒级，事件使用毫秒级 |

---

## 4. MQTT Topic 与 ACL

### 4.1 Topic 规范

| 方向 | Topic | QoS | 说明 |
| --- | --- | --- | --- |
| 设备订阅 | `pet/{deviceId}/cmd` | 1 | 下行指令 |
| 设备发布 | `pet/{deviceId}/telemetry` | 0 | 遥测上报 |
| 设备发布 | `pet/{deviceId}/cmd/ack` | 1 | 指令回执 |
| 设备发布 | `pet/{deviceId}/event` | 1 | 事件上报（V0.3） |

### 4.2 ACL 校验规则

网关强制校验：
- clientId == deviceId
- publish topic 只能是 `pet/{deviceId}/telemetry`、`pet/{deviceId}/cmd/ack`、`pet/{deviceId}/event`
- subscribe topic 只能是 `pet/{deviceId}/cmd`

---

## 5. 消息协议

### 5.1 命令信封（Core → Device）

```json
{
  "schemaVersion": 1,
  "type": "move",
  "reqId": "uuid",
  "ts": 1730000000,
  "payload": {
    "direction": "forward",
    "speed": 0.6,
    "durationMs": 800
  }
}
```

### 5.2 指令类型（V0.3）

| type | 说明 | payload 参数 |
| --- | --- | --- |
| move | 移动控制 | direction, speed, durationMs |
| stop | 停止 | 无 |
| setEmotion | 设置表情 | emotion |
| speak | 语音播报 | text, voice |
| playAnimation | 播放动画 | animation |
| setBrightness | 设置亮度 | brightness |
| setVolume | 设置音量 | volume |
| reboot | 重启设备 | 无 |

### 5.3 回执（Device → Core）

```json
{
  "schemaVersion": 1,
  "reqId": "uuid",
  "ok": true,
  "code": "DONE",
  "message": "moved forward",
  "ts": 1730000002
}
```

### 5.4 遥测（Device → Core）

```json
{
  "schemaVersion": 1,
  "ts": 1730000000,
  "battery": 87,
  "rssi": -55,
  "brightness": 80,
  "volume": 50,
  "version": "0.1.0"
}
```

### 5.5 事件（Device → Core）（V0.3 新增）

```json
{
  "eventId": "collision",
  "eventType": "alert",
  "timestamp": 1730000000000,
  "params": {
    "direction": "front",
    "intensity": 75
  }
}
```

---

## 6. pet-core 设计

### 6.1 模块划分

| 模块 | 职责 |
| --- | --- |
| DeviceService | 设备注册、secret 管理、在线状态、遥测查询 |
| CommandService | 指令创建、下发、ack 处理、超时扫描 |
| TelemetryService | 遥测写入 latest + 历史 |
| UserService | 用户注册、登录、管理（V0.2） |
| LicenseCodeService | 授权码生成、激活、撤销（V0.2） |
| PermissionService | 权限/角色查询（V0.2） |
| ProductService | 产品 CRUD、物模型管理（V0.3） |
| DeviceEventService | 事件记录、查询、统计（V0.3） |
| TimeSeriesService | TimescaleDB 时序数据写入与查询（V0.5） |
| WebSocketPushService | WebSocket 实时推送：指令状态、设备上下线（V0.5） |
| GatewayClient | 调用网关 API |

### 6.2 数据库表结构

#### V1 - 基础表

| 表名 | 说明 |
| --- | --- |
| device | 设备信息 |
| device_session | 设备会话/在线状态 |
| command | 指令记录 |
| telemetry_latest | 最新遥测 |
| telemetry_history | 遥测历史 |

#### V2 - 用户系统

| 表名 | 说明 |
| --- | --- |
| sys_user | 用户表 |
| sys_role | 角色表 |
| sys_permission | 权限表 |
| sys_user_role | 用户-角色关联 |
| sys_role_permission | 角色-权限关联 |
| license_code | 授权码表 |
| operation_log | 操作日志表 |

#### V3 - 物模型

| 表名 | 说明 |
| --- | --- |
| product | 产品表 |
| thing_model_property | 属性定义 |
| thing_model_service | 服务定义 |
| thing_model_event | 事件定义 |
| device_event | 设备事件记录 |

### 6.3 指令状态机

```
PENDING → SENT → ACKED/FAILED
              ↘ TIMEOUT
```

- 创建：`PENDING`
- 网关下发成功：`SENT`
- 收到 ack（ok=true）：`ACKED`
- 收到 ack（ok=false）：`FAILED`
- 超时（默认 10s）：`TIMEOUT`

### 6.4 REST API 分层

| 层级 | Controller | 说明 |
| --- | --- | --- |
| 公开 | AuthController | 注册、登录、退出 |
| 用户 | UserController | 当前用户信息、授权码激活 |
| 设备 | DeviceController | 设备 CRUD、指令、事件 |
| 管理 | AdminUserController | 用户管理 |
| 管理 | AdminLicenseController | 授权码管理 |
| 管理 | AdminLogController | 操作日志 |
| 管理 | AdminProductController | 产品/物模型管理 |
| 内部 | InternalController | 网关回调（telemetry/ack/event/presence） |

### 6.5 内部回调 API

| 接口 | 说明 |
| --- | --- |
| GET /internal/auth | 设备鉴权 |
| POST /internal/telemetry/{deviceId} | 遥测上报 |
| POST /internal/ack/{deviceId} | 指令回执 |
| POST /internal/event/{deviceId} | 事件上报（V0.3） |
| POST /internal/gateway/deviceOnline | 设备上线 |
| POST /internal/gateway/deviceOffline | 设备离线 |

---

## 7. mqtt-gateway 设计

### 7.1 职责边界

**网关只做：**
- CONNECT 鉴权（调用 Core /internal/auth）
- 在线会话管理
- Topic ACL 校验
- 上行转发到 Core（telemetry/ack/event）
- 下行从 Core 接收并转发给设备

**网关不做：**
- 复杂业务规则（在 Core 做）
- 完整 Broker 的订阅路由体系

### 7.2 核心内存结构

```java
Map<String, EndpointSession> sessions;

record EndpointSession(
    String deviceId,
    MqttEndpoint endpoint,
    Instant connectedAt,
    String clientIp
) {}
```

### 7.3 下行接口

```
POST /internal/command/send
{
  "deviceId": "pet001",
  "topic": "pet/pet001/cmd",
  "qos": 1,
  "payload": "{...json...}"
}
```

### 7.4 指标收集

| 指标 | 说明 |
| --- | --- |
| onlineCount | 当前在线设备数 |
| connectCount | 连接次数 |
| disconnectCount | 断开次数 |
| telemetryCount | 遥测上报次数 |
| ackCount | 回执次数 |
| eventCount | 事件上报次数（V0.3） |
| authFailCount | 鉴权失败次数 |
| callbackFailCount | 回调失败次数 |
| commandSendCount | 下发请求次数 |

---

## 8. 权限系统（V0.2）

### 8.1 RBAC 模型

```
用户 ←→ 角色 ←→ 权限
```

### 8.2 预置角色

| 角色 | 说明 | 权限 |
| --- | --- | --- |
| ADMIN | 管理员 | 全部权限 |
| USER | 普通用户 | 设备查看/控制 |
| OPERATOR | 运维人员 | 设备管理、日志查看 |

### 8.3 权限列表

| 权限 | 说明 |
| --- | --- |
| user:* | 用户管理 |
| role:* | 角色管理 |
| license:* | 授权码管理 |
| device:* | 设备管理 |
| product:* | 产品管理（V0.3） |
| log:view | 日志查看 |

### 8.4 Sa-Token 集成

- 使用 Redis 存储会话
- 支持并发登录
- Token 有效期 24 小时

---

## 9. 物模型系统（V0.3）

### 9.1 概念模型

```
产品 (Product)
  ├── 属性 (Property) - 设备状态
  ├── 服务 (Service) - 可下发指令
  └── 事件 (Event) - 设备上报通知
```

### 9.2 数据类型

| 类型 | 说明 |
| --- | --- |
| INT | 整数 |
| FLOAT | 浮点数 |
| BOOL | 布尔值 |
| STRING | 字符串 |
| ENUM | 枚举 |
| STRUCT | 结构体 |

### 9.3 事件类型

| 类型 | 说明 |
| --- | --- |
| INFO | 普通信息 |
| ALERT | 告警事件 |
| ERROR | 错误事件 |

### 9.4 默认产品

系统初始化创建 `deskpet-v1` 产品，包含：
- 5 个属性：battery, rssi, brightness, volume, version
- 8 个服务：move, stop, setEmotion, speak, playAnimation, setBrightness, setVolume, reboot
- 6 个事件：collision, touch, lowBattery, fall, voiceWakeup, buttonPress

---

## 10. 管理后台前端（V0.4）

### 10.1 技术栈

| 技术 | 版本 | 说明 |
| --- | --- | --- |
| Vue 3 | 3.5 | Composition API + `<script setup>` |
| TypeScript | 5.9 | 类型安全 |
| Vue Router | 4.6 | 路由管理 |
| Pinia | 3.0 | 状态管理 |
| Element Plus | 2.13 | UI 组件库 |
| Axios | 1.13 | HTTP 客户端 |
| ECharts | 6.0 | 数据可视化 |
| Vite | 7.2 | 构建工具 |

### 10.2 目录结构

```
deskpetConsole/frontend/src/
├── api/                    # API 层
│   ├── device.ts          # 设备相关 API
│   ├── license.ts         # 授权码管理 API
│   ├── logs.ts            # 日志相关 API
│   └── product.ts         # 产品与物模型 API
├── pages/                 # 页面组件
│   ├── Dashboard.vue      # 总览
│   ├── Licenses.vue       # 授权码管理
│   ├── Products.vue       # 产品列表
│   ├── ThingModel.vue     # 物模型编辑
│   ├── Devices.vue        # 设备列表
│   ├── DeviceDetail.vue   # 设备详情
│   ├── Commands.vue       # 指令下发
│   ├── Telemetry.vue      # 遥测数据
│   ├── Logs.vue           # 日志告警
│   └── Settings.vue       # 设置
├── types/                 # TypeScript 类型定义
│   ├── api.ts             # 通用错误响应
│   ├── device.d.ts        # 设备类型
│   ├── license.ts         # 授权码类型
│   ├── logs.ts            # 日志类型
│   └── product.ts         # 产品与物模型类型
├── router/index.ts        # 路由配置
├── utils/request.ts       # Axios 实例（自动 Bearer Token）
└── App.vue                # 根组件（侧边栏导航）
```

### 10.3 路由表

| 路径 | 页面 | 说明 |
| --- | --- | --- |
| `/` | Dashboard | 总览 |
| `/licenses` | Licenses | 授权码管理 |
| `/products` | Products | 产品列表 |
| `/products/:productKey` | ThingModel | 物模型编辑 |
| `/devices` | Devices | 设备列表 |
| `/devices/:id` | DeviceDetail | 设备详情 |
| `/commands` | Commands | 指令下发 |
| `/telemetry` | Telemetry | 遥测数据 |
| `/logs` | Logs | 日志告警 |
| `/settings` | Settings | 设置 |

### 10.4 API 代理

开发模式下 Vite 将 `/api` 代理到 `http://localhost:8080`，前端 API 调用路径如 `api/admin/licenses` 会被代理到后端 `http://localhost:8080/api/admin/licenses`。

---

## 11. 本地开发

### 11.1 环境要求

- JDK 17+
- Maven 3.8+
- Docker（用于 PostgreSQL、Redis）
- Node.js 18+（前端开发）

### 11.2 启动顺序

1. 启动 PostgreSQL + Redis
   ```bash
   docker compose -f deploy/docker-compose.yml --profile redis up -d
   ```

2. 启动 pet-core
   ```bash
   mvn -pl pet-core spring-boot:run
   ```

3. 启动 mqtt-gateway
   ```bash
   mvn -pl mqtt-gateway exec:java
   ```

4. 访问 Swagger UI
   ```
   http://localhost:8080/swagger-ui/index.html
   ```

### 11.3 默认配置

| 服务 | 端口 | 说明 |
| --- | --- | --- |
| pet-core | 8080 | REST API |
| mqtt-gateway | 1883 | MQTT |
| mqtt-gateway | 8081 | 内部 HTTP |
| PostgreSQL | 5432 | 数据库 |
| Redis | 6379 | 缓存 |

### 11.4 默认账户

| 用户名 | 密码 | 角色 |
| --- | --- | --- |
| admin | admin123 | ADMIN |

---

## 12. 测试

### 12.1 单元测试

```bash
mvn -pl pet-core test
```

### 12.2 集成测试

```bash
mvn -pl pet-core verify
```

### 12.3 设备模拟

使用 MQTT 客户端工具（如 MQTTX）模拟设备：

1. 连接参数
   - Host: localhost:1883
   - ClientId: pet001
   - Username: pet001
   - Password: （设备 secret）

2. 订阅 `pet/pet001/cmd`

3. 发布遥测到 `pet/pet001/telemetry`

4. 发布事件到 `pet/pet001/event`

---

## 13. 安全要求

### 13.1 必做项

- 设备鉴权：username=deviceId, password=secret
- 内部接口：配置 internal.token 或限制内网访问
- Topic ACL：严格校验 deviceId
- 密码存储：BCrypt 加密

### 13.2 生产建议

- 使用 HTTPS（通过反向代理）
- 修改默认管理员密码
- 配置防火墙规则
- 启用审计日志

---

## 14. 迭代路线

| 版本 | 功能 |
| --- | --- |
| V0.4 | 前端分离：管理后台增强 + 用户端 |
| V0.5 | 可观测性：TimescaleDB + Alertmanager |
| V0.6 | 行为状态机 + 定时卖萌 + 事件触发响应 |
| V0.7 | TTS 语音播报 |
| V0.8 | Spring AI 集成（工具调用） |
