# 测试与模拟

## 1. 前置准备

```bash
pip install -r scripts/requirements.txt
```

确保 `pet-core`、`mqtt-gateway` 已启动，并已注册设备：

```bash
curl -X POST http://localhost:8080/api/devices \
  -H "Content-Type: application/json" \
  -d "{\"deviceId\":\"pet-001\",\"secret\":\"secret123\",\"model\":\"deskpet\",\"remark\":\"demo\"}"
```

## 2. 设备模拟脚本（MQTT 行为）

启动设备模拟器（telemetry/ack/重连）：

```bash
python scripts/device_simulator.py --device-id pet-001 --secret secret123 \
  --mqtt-host localhost --mqtt-port 1883 \
  --telemetry-interval 5 --ack-delay-ms 200 \
  --reconnect-interval 30 --reconnect-down-seconds 3
```

验证方法：

```bash
curl http://localhost:8080/api/devices/pet-001
```

返回的 `telemetry` 字段应持续更新。

## 3. 协议测试（telemetry / ack）

1) 启动设备模拟器  
2) 在 `pet-core` 日志中观察 `telemetry/ack` 回调处理  
3) 调用命令下发接口：

```bash
curl -X POST http://localhost:8080/api/devices/pet-001/commands \
  -H "Content-Type: application/json" \
  -d "{\"type\":\"move\",\"payload\":{\"direction\":\"left\",\"speed\":0.4,\"durationMs\":500}}"
```

随后查询指令状态：

```bash
curl http://localhost:8080/api/devices/pet-001/commands/{reqId}
```

期望看到 `ACKED`。

## 4. 压力冒烟（100 次下发闭环）

```bash
python scripts/smoke_test.py --device-id pet-001 --count 100 --interval-ms 50
```

输出示例：

```
[result] {"ACKED": 100, "FAILED": 0, "TIMEOUT": 0}
```

## 5. 异常场景验证

### 5.1 网关重启

1) 保持设备模拟器运行  
2) 重启 `mqtt-gateway`  
3) 观察设备自动重连，`pet-core` 中在线状态恢复  

### 5.2 Core 重启

1) 保持设备模拟器运行  
2) 重启 `pet-core`  
3) 重启后继续下发指令与接收遥测

### 5.3 断网重连

通过设备模拟器的 `--reconnect-interval` 模拟断线重连，观察网关日志与在线数变化。
