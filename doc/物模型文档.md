# 物模型文档

适用范围：DeskPet V0.3

---

## 1. 概述

物模型是对设备能力的抽象描述，包含三大类定义：

- **属性（Property）**：设备状态数据，通过遥测上报
- **服务（Service）**：可下发给设备的指令
- **事件（Event）**：设备主动上报的通知

V0.3 支持动态物模型管理，可通过 API 创建产品并定义物模型。

---

## 2. 产品与物模型

### 2.1 产品（Product）

产品代表一类设备型号，每个产品包含完整的物模型定义。

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| productKey | string | 产品唯一标识 |
| productName | string | 产品名称 |
| description | string | 产品描述 |
| status | enum | 状态：ACTIVE / DEPRECATED |

### 2.2 默认产品

系统初始化时创建默认产品 `deskpet-v1`，包含完整的物模型定义。

---

## 3. 属性定义（Property）

### 3.1 属性结构

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| identifier | string | 属性标识符 |
| name | string | 属性名称 |
| dataType | enum | 数据类型 |
| accessMode | enum | 访问模式：R（只读）/ RW（读写） |
| required | boolean | 是否必填 |
| specs | object | 数据规格（取值范围等） |
| description | string | 属性描述 |

### 3.2 数据类型

| 类型 | 说明 | specs 示例 |
| --- | --- | --- |
| INT | 整数 | `{"min": 0, "max": 100, "unit": "%"}` |
| FLOAT | 浮点数 | `{"min": 0.0, "max": 1.0, "step": 0.1}` |
| BOOL | 布尔值 | `{"0": "关闭", "1": "开启"}` |
| STRING | 字符串 | `{"maxLength": 64}` |
| ENUM | 枚举 | `{"idle": "空闲", "happy": "开心"}` |
| STRUCT | 结构体 | 嵌套属性定义 |

### 3.3 默认属性列表

| 标识符 | 名称 | 类型 | 访问 | 说明 |
| --- | --- | --- | --- | --- |
| battery | 电量 | INT | R | 0-100% |
| rssi | 信号强度 | INT | R | dBm |
| brightness | 亮度 | INT | RW | 0-100 |
| volume | 音量 | INT | RW | 0-100 |
| version | 固件版本 | STRING | R | 版本号 |

---

## 4. 服务定义（Service）

### 4.1 服务结构

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| identifier | string | 服务标识符（对应指令 type） |
| name | string | 服务名称 |
| callType | enum | 调用类型：ASYNC / SYNC |
| inputParams | array | 输入参数列表 |
| outputParams | array | 输出参数列表 |
| description | string | 服务描述 |

### 4.2 参数结构

```json
{
  "identifier": "direction",
  "name": "方向",
  "dataType": "ENUM",
  "specs": {
    "forward": "前进",
    "backward": "后退",
    "left": "左转",
    "right": "右转"
  }
}
```

### 4.3 默认服务列表

| 标识符 | 名称 | 调用类型 | 输入参数 |
| --- | --- | --- | --- |
| move | 移动控制 | ASYNC | direction, speed, durationMs |
| stop | 停止 | ASYNC | 无 |
| setEmotion | 设置表情 | ASYNC | emotion |
| speak | 语音播报 | ASYNC | text, voice |
| playAnimation | 播放动画 | ASYNC | animation |
| setBrightness | 设置亮度 | ASYNC | brightness |
| setVolume | 设置音量 | ASYNC | volume |
| reboot | 重启设备 | ASYNC | 无 |

### 4.4 服务参数详情

#### move（移动控制）

| 参数 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| direction | ENUM | 是 | forward/backward/left/right |
| speed | FLOAT | 是 | 0.0-1.0 |
| durationMs | INT | 是 | 50-5000ms |

#### setEmotion（设置表情）

| 参数 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| emotion | ENUM | 是 | idle/happy/sad/angry/sleepy/excited/confused |

#### speak（语音播报）

| 参数 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| text | STRING | 是 | 播报文本（最大200字符） |
| voice | ENUM | 否 | default/cute/robot |

#### playAnimation（播放动画）

| 参数 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| animation | ENUM | 是 | wave/dance/nod/shake/sleep/wakeup |

#### setBrightness / setVolume

| 参数 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| brightness/volume | INT | 是 | 0-100 |

---

## 5. 事件定义（Event）

### 5.1 事件结构

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| identifier | string | 事件标识符 |
| name | string | 事件名称 |
| eventType | enum | 事件类型：INFO / ALERT / ERROR |
| outputParams | array | 输出参数列表 |
| description | string | 事件描述 |

### 5.2 事件类型

| 类型 | 说明 | 使用场景 |
| --- | --- | --- |
| INFO | 普通信息 | 触摸、按键、语音唤醒 |
| ALERT | 告警事件 | 碰撞、低电量 |
| ERROR | 错误事件 | 跌落、硬件故障 |

### 5.3 默认事件列表

| 标识符 | 名称 | 类型 | 输出参数 |
| --- | --- | --- | --- |
| collision | 碰撞事件 | ALERT | direction, intensity |
| touch | 触摸事件 | INFO | position, duration |
| lowBattery | 低电量告警 | ALERT | level |
| fall | 跌落事件 | ERROR | height |
| voiceWakeup | 语音唤醒 | INFO | keyword, confidence |
| buttonPress | 按键事件 | INFO | button, pressType |

### 5.4 事件参数详情

#### collision（碰撞事件）

| 参数 | 类型 | 说明 |
| --- | --- | --- |
| direction | STRING | 碰撞方向：front/back/left/right |
| intensity | INT | 碰撞强度：0-100 |

#### touch（触摸事件）

| 参数 | 类型 | 说明 |
| --- | --- | --- |
| position | STRING | 触摸位置：head/back/belly |
| duration | INT | 触摸时长（毫秒） |

#### lowBattery（低电量告警）

| 参数 | 类型 | 说明 |
| --- | --- | --- |
| level | INT | 当前电量百分比 |

#### fall（跌落事件）

| 参数 | 类型 | 说明 |
| --- | --- | --- |
| height | FLOAT | 估算跌落高度（米） |

#### voiceWakeup（语音唤醒）

| 参数 | 类型 | 说明 |
| --- | --- | --- |
| keyword | STRING | 唤醒词 |
| confidence | FLOAT | 置信度：0.0-1.0 |

#### buttonPress（按键事件）

| 参数 | 类型 | 说明 |
| --- | --- | --- |
| button | STRING | 按键标识 |
| pressType | STRING | 按键类型：short/long/double |

---

## 6. MQTT 通讯

### 6.1 Topic 规范

| 方向 | Topic | QoS | 说明 |
| --- | --- | --- | --- |
| 订阅 | `pet/{deviceId}/cmd` | 1 | 下行指令 |
| 发布 | `pet/{deviceId}/cmd/ack` | 1 | 指令回执 |
| 发布 | `pet/{deviceId}/telemetry` | 0 | 遥测上报 |
| 发布 | `pet/{deviceId}/event` | 1 | 事件上报 |

### 6.2 遥测上报格式

```json
{
  "schemaVersion": 1,
  "ts": 1730000000,
  "battery": 87,
  "rssi": -55,
  "brightness": 80,
  "volume": 50,
  "version": "0.1.0"
}
```

### 6.3 事件上报格式

```json
{
  "eventId": "collision",
  "eventType": "alert",
  "timestamp": 1730000000000,
  "params": {
    "direction": "front",
    "intensity": 75
  }
}
```

### 6.4 指令下发格式

```json
{
  "schemaVersion": 1,
  "type": "move",
  "reqId": "uuid",
  "ts": 1730000000,
  "payload": {
    "direction": "forward",
    "speed": 0.6,
    "durationMs": 800
  }
}
```

### 6.5 指令回执格式

```json
{
  "schemaVersion": 1,
  "reqId": "uuid",
  "ok": true,
  "code": "DONE",
  "message": "moved forward",
  "ts": 1730000002
}
```

---

## 7. 物模型 API

### 7.1 产品管理

```
POST   /api/admin/products                    # 创建产品
GET    /api/admin/products                    # 产品列表
GET    /api/admin/products/{productKey}       # 产品详情（含物模型）
PUT    /api/admin/products/{productKey}       # 更新产品
DELETE /api/admin/products/{productKey}       # 删除产品
```

### 7.2 属性管理

```
POST   /api/admin/products/{productKey}/properties      # 添加属性
PUT    /api/admin/products/{productKey}/properties/{id} # 更新属性
DELETE /api/admin/products/{productKey}/properties/{id} # 删除属性
```

### 7.3 服务管理

```
POST   /api/admin/products/{productKey}/services        # 添加服务
PUT    /api/admin/products/{productKey}/services/{id}   # 更新服务
DELETE /api/admin/products/{productKey}/services/{id}   # 删除服务
```

### 7.4 事件管理

```
POST   /api/admin/products/{productKey}/events          # 添加事件
PUT    /api/admin/products/{productKey}/events/{id}     # 更新事件
DELETE /api/admin/products/{productKey}/events/{id}     # 删除事件
```

### 7.5 导入导出

```
GET    /api/admin/products/{productKey}/export          # 导出物模型JSON
POST   /api/admin/products/{productKey}/import          # 导入物模型JSON
```

---

## 8. 设备事件查询

```
GET    /api/devices/{deviceId}/events                   # 事件历史
GET    /api/devices/{deviceId}/events/stats             # 事件统计
```

### 8.1 事件历史查询参数

| 参数 | 类型 | 说明 |
| --- | --- | --- |
| eventId | string | 事件标识符（可选） |
| eventType | string | 事件类型（可选） |
| startTime | datetime | 开始时间（可选） |
| endTime | datetime | 结束时间（可选） |
| page | int | 页码（默认0） |
| size | int | 每页大小（默认20） |

### 8.2 事件统计响应

```json
{
  "total": 156,
  "byEventId": {
    "collision": 45,
    "touch": 89,
    "lowBattery": 12,
    "buttonPress": 10
  },
  "byEventType": {
    "INFO": 99,
    "ALERT": 57,
    "ERROR": 0
  }
}
```

---

## 9. 设备侧实现要求

### 9.1 遥测上报

- 建议频率：5秒一次
- 必填字段：ts、battery
- 可选字段：rssi、brightness、volume、version

### 9.2 事件上报

- 事件发生时立即上报
- timestamp 使用毫秒级时间戳
- params 根据事件类型填充对应参数

### 9.3 指令处理

- 幂等：缓存最近 N 个 reqId，重复不执行
- 安全限幅：对 speed/duration 做限制
- 频率限制：高频指令可拒绝并回 BUSY

### 9.4 回执 code 枚举

| code | 说明 |
| --- | --- |
| DONE | 成功执行 |
| BAD_PAYLOAD | 参数缺失或非法 |
| SAFETY_LIMIT | 触发安全限幅 |
| BUSY | 当前动作占用 |
| DUPLICATE | 重复 reqId |
| INTERNAL_ERROR | 设备内部异常 |
