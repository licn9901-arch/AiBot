# 物模型文档（设备侧）

适用范围：DeskPet V0.1（MVP）

本物模型以设备固件实现为主，字段命名与当前系统实现保持一致，便于设备端与 Core/MQTT 网关对接。

---

## 1. 通用标识字段

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| deviceId | string | 是 | 设备唯一标识，与 MQTT clientId/username 一致。 |
| schemaVersion | int | 是 | 协议版本，当前固定为 1。 |
| reqId | string | 条件 | 指令唯一标识（UUID），仅在指令/回执中出现。 |
| ts | long | 是 | Unix 时间戳（秒），指令/回执/遥测均需携带。 |

---

## 2. 属性（Telemetry）

上报通道：`pet/{deviceId}/telemetry`  
说明：属性以遥测上报为准，平台侧在线状态由网关连接事件产生，设备无需上报 presence。

| 属性 | 类型 | 必填 | 说明 | 取值/范围 |
| --- | --- | --- | --- | --- |
| firmwareVersion | string | 否 | 固件版本号。 | 例如 `0.1.0` |
| rssi | int | 否 | Wi-Fi 信号强度（dBm）。 | 例如 `-55` |
| battery | double | 否 | 电量百分比（0~1）。 | 0.0 ~ 1.0 |
| lastAction | string | 否 | 最近一次执行的动作。 | `move`/`stop`/`setEmotion` |
| extra | object | 否 | 扩展字段，业务侧透传。 | 任意 JSON 对象 |

---

## 3. 服务（指令）

指令下行通道：`pet/{deviceId}/cmd`  
指令统一包裹在命令信封（Command Envelope）中。

### 3.1 指令类型一览

| type | 说明 |
| --- | --- |
| move | 移动指令 |
| stop | 停止指令 |
| setEmotion | 表情指令 |

### 3.2 指令 payload 规范

#### move

| 字段 | 类型 | 必填 | 说明 | 取值/范围 |
| --- | --- | --- | --- | --- |
| direction | string | 是 | 移动方向 | `forward`/`backward`/`left`/`right` |
| speed | double | 是 | 速度比例 | 0.0 ~ 1.0（设备端需二次限幅） |
| durationMs | int | 是 | 持续时间（毫秒） | 建议 50 ~ 5000 |

#### stop

payload 允许为空对象 `{}` 或直接省略。

#### setEmotion

| 字段 | 类型 | 必填 | 说明 | 取值/范围 |
| --- | --- | --- | --- | --- |
| emotion | string | 是 | 表情类型 | `idle`/`happy`/`sad`/`angry`/`sleepy` |
| durationMs | int | 否 | 表情持续时间（毫秒） | 建议 200 ~ 5000 |

---

## 4. 回执（Ack）

回执上行通道：`pet/{deviceId}/cmd/ack`

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| schemaVersion | int | 是 | 协议版本，当前为 1。 |
| reqId | string | 是 | 对应指令的 reqId。 |
| ok | boolean | 是 | 执行结果。 |
| code | string | 是 | 结果码（英文）。 |
| message | string | 否 | 结果说明（英文）。 |
| ts | long | 是 | Unix 时间戳（秒）。 |

### 建议 code 枚举

| code | 说明 |
| --- | --- |
| DONE | 成功执行 |
| BAD_PAYLOAD | 参数缺失或非法 |
| SAFETY_LIMIT | 触发安全限幅/安全策略 |
| BUSY | 当前动作占用，无法执行 |
| DUPLICATE | 重复 reqId（已处理） |
| INTERNAL_ERROR | 设备内部异常 |

---

## 5. 设备侧安全与幂等要求

1. **速度与时长限幅**：设备端必须对 `speed` 与 `durationMs` 做二次限幅，避免安全风险。
2. **指令幂等**：维护最近 N 个 `reqId` 的环形缓存（建议 32/64）。重复 reqId 不重复执行，只回执。
3. **频率限制**：若命令过于频繁，设备可拒绝并回 `BUSY` 或 `SAFETY_LIMIT`。

---

## 6. JSON 示例

### 6.1 下行指令（move）

```json
{
  "schemaVersion": 1,
  "type": "move",
  "reqId": "5b4c8e0a-6f22-4a9a-9c3c-8d5d7b18c7a4",
  "ts": 1730000000,
  "payload": {
    "direction": "forward",
    "speed": 0.6,
    "durationMs": 800
  }
}
```

### 6.2 上行回执（成功）

```json
{
  "schemaVersion": 1,
  "reqId": "5b4c8e0a-6f22-4a9a-9c3c-8d5d7b18c7a4",
  "ok": true,
  "code": "DONE",
  "message": "moved forward",
  "ts": 1730000002
}
```

### 6.3 遥测上报

```json
{
  "schemaVersion": 1,
  "ts": 1730000000,
  "firmwareVersion": "0.1.0",
  "rssi": -55,
  "battery": 0.87,
  "lastAction": "move",
  "extra": {
    "motorTemp": 42.5
  }
}
```
