# 部署与运维

## 1. docker-compose（DB + 可选 Redis）

```bash
docker compose -f deploy/docker-compose.yml up -d
```

启用 Redis：

```bash
docker compose -f deploy/docker-compose.yml --profile redis up -d
```

## 2. pet-core 配置说明

支持通过 `application.yml` 或环境变量覆盖：

| 配置项 | 环境变量 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `server.port` | `SERVER_PORT` | `8080` | HTTP 端口 |
| `spring.datasource.url` | `DB_URL` | `jdbc:postgresql://localhost:5432/postgres?currentSchema=deskpet&stringtype=unspecified` | 数据库地址 |
| `spring.datasource.username` | `DB_USER` | `postgres` | 数据库用户 |
| `spring.datasource.password` | `DB_PASSWORD` | `123456` | 数据库密码 |
| `gateway.baseUrl` | `GATEWAY_BASE_URL` | `http://localhost:8081` | 网关内部地址 |
| `internal.token` | `INTERNAL_TOKEN` | 空 | 内部接口 Token |
| `command.timeoutSec` | `COMMAND_TIMEOUT_SEC` | `10` | 指令超时秒数 |
| `command.timeoutScanMs` | `COMMAND_TIMEOUT_SCAN_MS` | `2000` | 超时扫描间隔 |

示例：

```bash
set DB_URL=jdbc:postgresql://localhost:5432/deskpet?currentSchema=deskpet
mvn -pl pet-core spring-boot:run
```

## 3. mqtt-gateway 配置说明

默认从 `config.yaml` 读取，可用 `-Dgateway.config=path` 指定配置路径。

| 配置项 | 默认值 | 说明 |
| --- | --- | --- |
| `mqtt.port` | `1883` | MQTT 端口 |
| `internal.port` | `8081` | 网关内部 HTTP 端口 |
| `core.internalBaseUrl` | `http://localhost:8080` | Core 内部地址 |
| `gateway.instanceId` | `gateway-1` | 网关实例 ID |
| `internal.token` | 空 | 内部接口 Token |
| `auth.timeoutMs` | `2000` | `/internal/auth` 超时 |
| `auth.maxRetries` | `1` | `/internal/auth` 重试次数 |
| `auth.retryDelayMs` | `200` | `/internal/auth` 重试间隔 |
| `auth.failOpen` | `false` | `/internal/auth` 失败降级放行 |
| `callback.timeoutMs` | `2000` | telemetry/ack/presence 回调超时 |
| `callback.maxRetries` | `1` | 回调重试次数 |
| `callback.retryDelayMs` | `200` | 回调重试间隔 |
| `metrics.enabled` | `false` | Prometheus 指标开关 |
| `metrics.path` | `/metrics` | 指标路径 |
| `stats.logIntervalSec` | `60` | 统计日志间隔(秒) |

## 4. 日志级别与输出策略

### pet-core（logback）

- 默认输出控制台  
- 可选文件落盘：启用 `file` profile  

```bash
set LOG_LEVEL=INFO
set LOG_FILE=logs/pet-core.log
set SPRING_PROFILES_ACTIVE=file
mvn -pl pet-core spring-boot:run
```

### mqtt-gateway（log4j2）

- 默认使用 `log4j2.xml`（仅控制台）  
- 可选文件落盘：切换到 `log4j2-file.xml`

```bash
java -Dlog4j.configurationFile=classpath:log4j2-file.xml -DLOG_FILE=logs/mqtt-gateway.log -DLOG_LEVEL=INFO -jar mqtt-gateway.jar
```

## 5. Prometheus 指标（可选）

启用 `metrics.enabled=true` 后访问：

```
http://<gateway-host>:<internal.port><metrics.path>
```

例如：

```
http://localhost:8081/metrics
```
