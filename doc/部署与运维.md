# 部署与运维

适用范围：DeskPet V0.3

## 1. docker-compose（DB + Redis）

```bash
docker compose -f deploy/docker-compose.yml up -d
```

启用 Redis（V0.2 起必需）：

```bash
docker compose -f deploy/docker-compose.yml --profile redis up -d
```

## 2. pet-core 配置说明

支持通过 `application.yml` 或环境变量覆盖：

### 2.1 基础配置

| 配置项 | 环境变量 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `server.port` | `SERVER_PORT` | `8080` | HTTP 端口 |
| `spring.datasource.url` | `DB_URL` | `jdbc:postgresql://localhost:5432/postgres?currentSchema=deskpet&stringtype=unspecified` | 数据库地址 |
| `spring.datasource.username` | `DB_USER` | `postgres` | 数据库用户 |
| `spring.datasource.password` | `DB_PASSWORD` | `123456` | 数据库密码 |
| `gateway.baseUrl` | `GATEWAY_BASE_URL` | `http://localhost:8081` | 网关内部地址 |
| `internal.token` | `INTERNAL_TOKEN` | 空 | 内部接口 Token |
| `command.timeoutSec` | `COMMAND_TIMEOUT_SEC` | `10` | 指令超时秒数 |
| `command.timeoutScanMs` | `COMMAND_TIMEOUT_SCAN_MS` | `2000` | 超时扫描间隔 |

### 2.2 Redis 配置（V0.2 起必需）

| 配置项 | 环境变量 | 默认值 | 说明 |
| --- | --- | --- | --- |
| `spring.redis.host` | `REDIS_HOST` | `localhost` | Redis 主机 |
| `spring.redis.port` | `REDIS_PORT` | `6379` | Redis 端口 |
| `spring.redis.password` | `REDIS_PASSWORD` | 空 | Redis 密码 |
| `spring.redis.database` | `REDIS_DATABASE` | `0` | Redis 数据库 |

### 2.3 Sa-Token 配置（V0.2 起）

| 配置项 | 默认值 | 说明 |
| --- | --- | --- |
| `sa-token.token-name` | `satoken` | Token 名称 |
| `sa-token.timeout` | `86400` | Token 有效期（秒） |
| `sa-token.is-concurrent` | `true` | 允许并发登录 |
| `sa-token.is-share` | `true` | 共享 Token |

示例：

```bash
set DB_URL=jdbc:postgresql://localhost:5432/deskpet?currentSchema=deskpet
set REDIS_HOST=localhost
mvn -pl pet-core spring-boot:run
```

## 3. mqtt-gateway 配置说明

默认从 `config.yaml` 读取，可用 `-Dgateway.config=path` 指定配置路径。

### 3.1 基础配置

| 配置项 | 默认值 | 说明 |
| --- | --- | --- |
| `mqtt.port` | `1883` | MQTT 端口 |
| `internal.port` | `8081` | 网关内部 HTTP 端口 |
| `core.internalBaseUrl` | `http://localhost:8080` | Core 内部地址 |
| `gateway.instanceId` | `gateway-1` | 网关实例 ID |
| `internal.token` | 空 | 内部接口 Token |

### 3.2 鉴权配置

| 配置项 | 默认值 | 说明 |
| --- | --- | --- |
| `auth.timeoutMs` | `2000` | `/internal/auth` 超时 |
| `auth.maxRetries` | `1` | `/internal/auth` 重试次数 |
| `auth.retryDelayMs` | `200` | `/internal/auth` 重试间隔 |
| `auth.failOpen` | `false` | `/internal/auth` 失败降级放行 |

### 3.3 回调配置

| 配置项 | 默认值 | 说明 |
| --- | --- | --- |
| `callback.timeoutMs` | `2000` | telemetry/ack/event/presence 回调超时 |
| `callback.maxRetries` | `1` | 回调重试次数 |
| `callback.retryDelayMs` | `200` | 回调重试间隔 |

### 3.4 指标配置

| 配置项 | 默认值 | 说明 |
| --- | --- | --- |
| `metrics.enabled` | `false` | Prometheus 指标开关 |
| `metrics.path` | `/metrics` | 指标路径 |
| `stats.logIntervalSec` | `60` | 统计日志间隔(秒) |

## 4. 日志级别与输出策略

### 4.1 pet-core（logback）

- 默认输出控制台
- 可选文件落盘：启用 `file` profile

```bash
set LOG_LEVEL=INFO
set LOG_FILE=logs/pet-core.log
set SPRING_PROFILES_ACTIVE=file
mvn -pl pet-core spring-boot:run
```

### 4.2 mqtt-gateway（log4j2）

- 默认使用 `log4j2.xml`（仅控制台）
- 可选文件落盘：切换到 `log4j2-file.xml`

```bash
java -Dlog4j.configurationFile=classpath:log4j2-file.xml -DLOG_FILE=logs/mqtt-gateway.log -DLOG_LEVEL=INFO -jar mqtt-gateway.jar
```

## 5. Prometheus 指标（可选）

启用 `metrics.enabled=true` 后访问：

```
http://<gateway-host>:<internal.port><metrics.path>
```

例如：

```
http://localhost:8081/metrics
```

### 5.1 可用指标

| 指标名 | 类型 | 说明 |
| --- | --- | --- |
| `deskpet_gateway_online` | gauge | 当前在线设备数 |
| `deskpet_gateway_connect_total` | counter | 连接次数 |
| `deskpet_gateway_disconnect_total` | counter | 断开次数 |
| `deskpet_gateway_telemetry_total` | counter | 遥测上报次数 |
| `deskpet_gateway_ack_total` | counter | 回执次数 |
| `deskpet_gateway_event_total` | counter | 事件上报次数（V0.3） |
| `deskpet_gateway_auth_fail_total` | counter | 鉴权失败次数 |
| `deskpet_gateway_auth_retry_total` | counter | 鉴权重试次数 |
| `deskpet_gateway_callback_fail_total` | counter | 回调失败次数 |
| `deskpet_gateway_command_send_total` | counter | 下发请求次数 |
| `deskpet_gateway_command_send_ok_total` | counter | 下发成功次数 |
| `deskpet_gateway_command_send_fail_total` | counter | 下发失败次数 |
| `deskpet_gateway_uptime_seconds` | gauge | 运行时长(秒) |

## 6. 数据库迁移

使用 Flyway 自动迁移，迁移脚本位于 `pet-core/src/main/resources/db/migration/`：

| 版本 | 文件 | 说明 |
| --- | --- | --- |
| V1 | `V1__init.sql` | 初始化：设备、会话、指令、遥测表 |
| V2 | `V2__user_rbac_license.sql` | 用户系统：用户、角色、权限、授权码、操作日志 |
| V3 | `V3__thing_model.sql` | 物模型：产品、属性、服务、事件定义、设备事件记录 |

## 7. 默认账户

| 用户名 | 密码 | 角色 | 说明 |
| --- | --- | --- | --- |
| admin | admin123 | ADMIN | 系统管理员 |

**重要**：生产环境请立即修改默认密码！

## 8. 启动顺序

1. PostgreSQL
2. Redis
3. pet-core
4. mqtt-gateway
5. 设备端连接网关

## 9. 健康检查

### 9.1 pet-core

```bash
curl http://localhost:8080/actuator/health
```

### 9.2 mqtt-gateway

```bash
curl http://localhost:8081/health
```

## 10. 生产环境建议

### 10.1 安全配置

- 修改默认管理员密码
- 配置 `internal.token` 保护内部接口
- 使用 HTTPS（通过反向代理）
- 配置防火墙，限制内部端口访问

### 10.2 性能配置

- 调整 JVM 参数（堆大小、GC 策略）
- 配置数据库连接池大小
- 配置 Redis 连接池

### 10.3 高可用

- pet-core 可水平扩展（无状态）
- mqtt-gateway 可多实例部署（需配置不同 instanceId）
- 使用 Redis 集群或哨兵模式
- 使用 PostgreSQL 主从复制

### 10.4 监控告警

- 接入 Prometheus + Grafana
- 配置 Alertmanager 告警规则
- 监控关键指标：在线设备数、指令成功率、响应延迟
