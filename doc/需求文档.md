# 需求文档 PRD：联网轮式桌宠（MVP 可迭代）

## 1. 文档信息

* 产品名称：联网轮式桌宠（DeskPet）
* 版本：V0.1（MVP）
* 作者：李臣楠
* 日期：2026-01-15
* 目标：**先跑通联网闭环 + 手动控制 + 表情 + 指令回执**，为后续 AI 扩展打底

---

## 2. 背景与定位

桌面轮式桌宠是一个放在桌面的小型机器人，具备：

* 简单移动（前进/后退/转向/停止）
* 简单表情（屏幕/OLED）
* 联网能力（云端/局域网均可）
* 后续可扩展 AI（对话、工具调用、自动行为）

**V0.1 只做“可用”**：设备能稳定连接、能接收命令并执行、能上报状态、能在控制台看到结果。

---

## 3. 目标（Goals）

### 3.1 V0.1 目标

1. 设备稳定在线（心跳/在线状态）
2. 云端可下发移动与表情指令
3. 设备执行后回执（成功/失败/原因）
4. 控制台（或 Postman/简单前端）可操作与查看结果
5. 架构上预留后续 AI 接入点（不实现 AI）

### 3.2 非目标（Non-goals，V0.1 不做）

* 语音对话、唤醒词、视觉
* 复杂避障/SLAM
* 完整 OTA（可预留字段/接口，不强制实现）
* 完整 MQTT Broker 功能（共享订阅、持久会话、复杂路由等）

---

## 4. 用户画像与使用场景

### 4.1 用户画像

* 主要用户：桌宠拥有者（开发者本人）
* 次要用户：同局域网/云端可授权访问的用户（家人/同事）

### 4.2 场景

* 在桌面上“动一动、卖个萌”
* 在控制台远程让它移动/切换表情
* 后续：通过 AI 让它根据指令自动组合动作

---

## 5. 术语

* 设备（Device）：桌宠本体（ESP32/MCU + 电机 + 显示）
* 网关（Gateway）：Vert.x MQTT 服务，负责设备接入与协议收发
* 核心服务（Core）：Spring Boot 服务，负责业务与数据
* 指令（Command）：云 -> 设备 的动作/表情命令
* 遥测（Telemetry）：设备 -> 云 的电量/信号/传感器等
* 回执（Ack）：设备对指令执行结果的确认

---

## 6. 功能需求（V0.1）

### 6.1 设备侧功能

1. MQTT 连接

* 连接到 `mqtt-gateway`
* 支持用户名密码鉴权
* 支持 keepalive 心跳
* 支持 LWT（离线遗嘱）或等价在线上报

2. 订阅与发布

* 订阅：`pet/{deviceId}/cmd`
* 发布：

    * `pet/{deviceId}/telemetry`
    * `pet/{deviceId}/cmd/ack`
    * `pet/{deviceId}/presence`（可选，或由 LWT 实现）

3. 执行动作（最小集合）

* 移动：`move`（direction + speed + durationMs）
* 停止：`stop`
* 表情：`setEmotion`（happy/sad/sleepy/angry/idle 等）

4. 安全限制（必须有）

* speed 上限
* durationMs 上限
* 若连续命令过于频繁，限流或丢弃（避免桌面冲撞）
* 命令幂等：同一个 `reqId` 重复到达不重复执行（至少做到“只回 ack，不重复动作”）

5. 遥测上报（最小集合）

* 电量（如果没有电池，可先上报固定值）
* RSSI（Wi-Fi）
* 设备版本（firmwareVersion）
* 最后执行动作（lastAction，可选）

---

### 6.2 网关（Vert.x MQTT）功能

1. 设备接入

* 接受 CONNECT
* 鉴权（基于 deviceId + secret）
* 维护 `deviceId -> connection(endpoint)` 映射
* 设备上线/离线事件通知 Core

2. 上行处理（设备 -> 云）

* 接收 `telemetry` / `ack`
* 校验 topic 白名单与 deviceId 一致性
* 转发给 Core（HTTP 或消息队列，V0.1 用 HTTP 即可）

3. 下行下发（云 -> 设备）

* 接收 Core 的“下发请求”
* 若设备在线：立即 publish 到设备
* 若设备不在线：返回不可达（由 Core 负责入库与重试）

4. 最小可观测性

* 连接日志
* 每个 device 的在线状态与最近心跳时间
* 上行/下行计数

---

### 6.3 Core（Spring Boot）功能

1. 设备管理

* 设备注册（deviceId、secret、型号、备注）
* 设备在线状态（由网关通知）
* 设备状态查询（最近遥测）

2. 指令管理

* 创建指令：move/stop/setEmotion
* 指令状态机：`PENDING -> SENT -> ACKED/FAILED/TIMEOUT`
* 超时：超过 N 秒未收到 ack，标记 TIMEOUT

3. 对外 API（给控制台/前端）

* 下发指令
* 查询设备状态
* 查询指令执行结果
* （可选）SSE/WS 推送执行结果

---

### 6.4 控制台（V0.1 可以极简）

* 可以先不做完整 UI：用 Swagger + Postman/简单 Web 页也行
* 能做到：

    * 查看设备列表/在线状态
    * 按钮：前进/后退/左转/右转/停止
    * 下拉：表情选择
    * 展示最近 N 条指令结果

---

## 7. 非功能需求（V0.1）

1. 延迟：云端下发到设备收到命令 < 500ms（局域网通常更低）
2. 可靠性：

* 网关异常重启不影响 Core 数据
* Core 重启不影响网关接入（但指令下发会短暂不可用）

3. 安全：

* 设备鉴权必须有（最少 username/password）
* 内部 API 不暴露公网（网关 <-> Core）

4. 可扩展性：

* 后续新增命令类型不破坏旧设备（建议加 `schemaVersion`）

---

## 8. 里程碑与验收标准

### V0.1（联网闭环）

* ✅ 设备可上线，Core 可见在线
* ✅ Core 下发 move/stop/setEmotion，设备执行
* ✅ 设备 ack 回传，Core 可查询到最终状态
* ✅ 连续执行 100 次命令不崩溃、不明显漂移

### V0.2（行为与定时）

* 状态机（idle/play/sleep/lowBattery）
* 定时卖萌/整点动作
* 更完整遥测与事件（触摸/碰撞）

### V0.3（语音输出）

* TTS（先不做 STT）
* “报时/番茄钟”技能

### V0.4（AI）

* Spring AI + Tool Calling
* AI 输出“动作计划”并调用 Core 的下发接口

---